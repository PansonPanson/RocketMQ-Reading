<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MQClientAPIImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">rocketmq-client 5.0.0-SNAPSHOT</a> &gt; <a href="index.source.html" class="el_package">org.apache.rocketmq.client.impl</a> &gt; <span class="el_source">MQClientAPIImpl.java</span></div><h1>MQClientAPIImpl.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the &quot;License&quot;); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.apache.rocketmq.client.impl;

import com.alibaba.fastjson.JSON;
import java.io.UnsupportedEncodingException;
import java.nio.ByteBuffer;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Properties;
import java.util.Set;
import java.util.concurrent.atomic.AtomicInteger;
import org.apache.commons.lang3.StringUtils;
import org.apache.rocketmq.client.ClientConfig;
import org.apache.rocketmq.client.consumer.AckCallback;
import org.apache.rocketmq.client.consumer.AckResult;
import org.apache.rocketmq.client.consumer.AckStatus;
import org.apache.rocketmq.client.consumer.PopCallback;
import org.apache.rocketmq.client.consumer.PopResult;
import org.apache.rocketmq.client.consumer.PopStatus;
import org.apache.rocketmq.client.consumer.PullCallback;
import org.apache.rocketmq.client.consumer.PullResult;
import org.apache.rocketmq.client.consumer.PullStatus;
import org.apache.rocketmq.client.exception.MQBrokerException;
import org.apache.rocketmq.client.exception.MQClientException;
import org.apache.rocketmq.client.exception.OffsetNotFoundException;
import org.apache.rocketmq.client.hook.SendMessageContext;
import org.apache.rocketmq.client.impl.consumer.PullResultExt;
import org.apache.rocketmq.client.impl.factory.MQClientInstance;
import org.apache.rocketmq.client.impl.producer.DefaultMQProducerImpl;
import org.apache.rocketmq.client.impl.producer.TopicPublishInfo;
import org.apache.rocketmq.client.log.ClientLogger;
import org.apache.rocketmq.client.producer.SendCallback;
import org.apache.rocketmq.client.producer.SendResult;
import org.apache.rocketmq.client.producer.SendStatus;
import org.apache.rocketmq.common.AclConfig;
import org.apache.rocketmq.common.DataVersion;
import org.apache.rocketmq.common.MQVersion;
import org.apache.rocketmq.common.MixAll;
import org.apache.rocketmq.common.PlainAccessConfig;
import org.apache.rocketmq.common.TopicConfig;
import org.apache.rocketmq.common.UtilAll;
import org.apache.rocketmq.common.admin.ConsumeStats;
import org.apache.rocketmq.common.admin.TopicStatsTable;
import org.apache.rocketmq.common.attribute.AttributeParser;
import org.apache.rocketmq.common.message.Message;
import org.apache.rocketmq.common.message.MessageBatch;
import org.apache.rocketmq.common.message.MessageClientIDSetter;
import org.apache.rocketmq.common.message.MessageConst;
import org.apache.rocketmq.common.message.MessageDecoder;
import org.apache.rocketmq.common.message.MessageExt;
import org.apache.rocketmq.common.message.MessageQueue;
import org.apache.rocketmq.common.message.MessageQueueAssignment;
import org.apache.rocketmq.common.message.MessageRequestMode;
import org.apache.rocketmq.common.namesrv.DefaultTopAddressing;
import org.apache.rocketmq.common.namesrv.NameServerUpdateCallback;
import org.apache.rocketmq.common.namesrv.TopAddressing;
import org.apache.rocketmq.common.protocol.NamespaceUtil;
import org.apache.rocketmq.common.protocol.RequestCode;
import org.apache.rocketmq.common.protocol.ResponseCode;
import org.apache.rocketmq.common.protocol.body.BrokerStatsData;
import org.apache.rocketmq.common.protocol.body.CheckClientRequestBody;
import org.apache.rocketmq.common.protocol.body.ClusterAclVersionInfo;
import org.apache.rocketmq.common.protocol.body.ClusterInfo;
import org.apache.rocketmq.common.protocol.body.ConsumeMessageDirectlyResult;
import org.apache.rocketmq.common.protocol.body.ConsumeStatsList;
import org.apache.rocketmq.common.protocol.body.ConsumerConnection;
import org.apache.rocketmq.common.protocol.body.ConsumerRunningInfo;
import org.apache.rocketmq.common.protocol.body.GetConsumerStatusBody;
import org.apache.rocketmq.common.protocol.body.GroupList;
import org.apache.rocketmq.common.protocol.body.HARuntimeInfo;
import org.apache.rocketmq.common.protocol.body.KVTable;
import org.apache.rocketmq.common.protocol.body.LockBatchRequestBody;
import org.apache.rocketmq.common.protocol.body.LockBatchResponseBody;
import org.apache.rocketmq.common.protocol.body.ProducerConnection;
import org.apache.rocketmq.common.protocol.body.QueryAssignmentRequestBody;
import org.apache.rocketmq.common.protocol.body.QueryAssignmentResponseBody;
import org.apache.rocketmq.common.protocol.body.ProducerTableInfo;
import org.apache.rocketmq.common.protocol.body.QueryConsumeQueueResponseBody;
import org.apache.rocketmq.common.protocol.body.QueryConsumeTimeSpanBody;
import org.apache.rocketmq.common.protocol.body.QueryCorrectionOffsetBody;
import org.apache.rocketmq.common.protocol.body.QuerySubscriptionResponseBody;
import org.apache.rocketmq.common.protocol.body.QueueTimeSpan;
import org.apache.rocketmq.common.protocol.body.ResetOffsetBody;
import org.apache.rocketmq.common.protocol.body.SetMessageRequestModeRequestBody;
import org.apache.rocketmq.common.protocol.body.SubscriptionGroupWrapper;
import org.apache.rocketmq.common.protocol.body.TopicConfigSerializeWrapper;
import org.apache.rocketmq.common.protocol.body.TopicList;
import org.apache.rocketmq.common.protocol.body.UnlockBatchRequestBody;
import org.apache.rocketmq.common.protocol.header.AckMessageRequestHeader;
import org.apache.rocketmq.common.protocol.header.AddBrokerRequestHeader;
import org.apache.rocketmq.common.protocol.header.ChangeInvisibleTimeRequestHeader;
import org.apache.rocketmq.common.protocol.header.ChangeInvisibleTimeResponseHeader;
import org.apache.rocketmq.common.protocol.header.CloneGroupOffsetRequestHeader;
import org.apache.rocketmq.common.protocol.header.ConsumeMessageDirectlyResultRequestHeader;
import org.apache.rocketmq.common.protocol.header.ConsumerSendMsgBackRequestHeader;
import org.apache.rocketmq.common.protocol.header.CreateAccessConfigRequestHeader;
import org.apache.rocketmq.common.protocol.header.CreateTopicRequestHeader;
import org.apache.rocketmq.common.protocol.header.DeleteAccessConfigRequestHeader;
import org.apache.rocketmq.common.protocol.header.DeleteSubscriptionGroupRequestHeader;
import org.apache.rocketmq.common.protocol.header.DeleteTopicRequestHeader;
import org.apache.rocketmq.common.protocol.header.EndTransactionRequestHeader;
import org.apache.rocketmq.common.protocol.header.ExtraInfoUtil;
import org.apache.rocketmq.common.protocol.header.GetAllProducerInfoRequestHeader;
import org.apache.rocketmq.common.protocol.header.GetBrokerAclConfigResponseHeader;
import org.apache.rocketmq.common.protocol.header.GetBrokerClusterAclConfigResponseBody;
import org.apache.rocketmq.common.protocol.header.GetConsumeStatsInBrokerHeader;
import org.apache.rocketmq.common.protocol.header.GetConsumeStatsRequestHeader;
import org.apache.rocketmq.common.protocol.header.GetConsumerConnectionListRequestHeader;
import org.apache.rocketmq.common.protocol.header.GetConsumerListByGroupRequestHeader;
import org.apache.rocketmq.common.protocol.header.GetConsumerListByGroupResponseBody;
import org.apache.rocketmq.common.protocol.header.GetConsumerRunningInfoRequestHeader;
import org.apache.rocketmq.common.protocol.header.GetConsumerStatusRequestHeader;
import org.apache.rocketmq.common.protocol.header.GetEarliestMsgStoretimeRequestHeader;
import org.apache.rocketmq.common.protocol.header.GetEarliestMsgStoretimeResponseHeader;
import org.apache.rocketmq.common.protocol.header.GetMaxOffsetRequestHeader;
import org.apache.rocketmq.common.protocol.header.GetMaxOffsetResponseHeader;
import org.apache.rocketmq.common.protocol.header.GetMinOffsetRequestHeader;
import org.apache.rocketmq.common.protocol.header.GetMinOffsetResponseHeader;
import org.apache.rocketmq.common.protocol.header.GetProducerConnectionListRequestHeader;
import org.apache.rocketmq.common.protocol.header.GetSubscriptionGroupConfigRequestHeader;
import org.apache.rocketmq.common.protocol.header.GetTopicConfigRequestHeader;
import org.apache.rocketmq.common.protocol.header.GetTopicStatsInfoRequestHeader;
import org.apache.rocketmq.common.protocol.header.GetTopicsByClusterRequestHeader;
import org.apache.rocketmq.common.protocol.header.PopMessageRequestHeader;
import org.apache.rocketmq.common.protocol.header.PopMessageResponseHeader;
import org.apache.rocketmq.common.protocol.header.PullMessageRequestHeader;
import org.apache.rocketmq.common.protocol.header.PullMessageResponseHeader;
import org.apache.rocketmq.common.protocol.header.QueryConsumeQueueRequestHeader;
import org.apache.rocketmq.common.protocol.header.QueryConsumeTimeSpanRequestHeader;
import org.apache.rocketmq.common.protocol.header.QueryConsumerOffsetRequestHeader;
import org.apache.rocketmq.common.protocol.header.QueryConsumerOffsetResponseHeader;
import org.apache.rocketmq.common.protocol.header.QueryCorrectionOffsetHeader;
import org.apache.rocketmq.common.protocol.header.QueryMessageRequestHeader;
import org.apache.rocketmq.common.protocol.header.QuerySubscriptionByConsumerRequestHeader;
import org.apache.rocketmq.common.protocol.header.QueryTopicConsumeByWhoRequestHeader;
import org.apache.rocketmq.common.protocol.header.QueryTopicsByConsumerRequestHeader;
import org.apache.rocketmq.common.protocol.header.RemoveBrokerRequestHeader;
import org.apache.rocketmq.common.protocol.header.ResetMasterFlushOffsetHeader;
import org.apache.rocketmq.common.protocol.header.ResetOffsetRequestHeader;
import org.apache.rocketmq.common.protocol.header.ResumeCheckHalfMessageRequestHeader;
import org.apache.rocketmq.common.protocol.header.SearchOffsetRequestHeader;
import org.apache.rocketmq.common.protocol.header.SearchOffsetResponseHeader;
import org.apache.rocketmq.common.protocol.header.SendMessageRequestHeader;
import org.apache.rocketmq.common.protocol.header.SendMessageRequestHeaderV2;
import org.apache.rocketmq.common.protocol.header.SendMessageResponseHeader;
import org.apache.rocketmq.common.protocol.header.UnregisterClientRequestHeader;
import org.apache.rocketmq.common.protocol.header.UpdateConsumerOffsetRequestHeader;
import org.apache.rocketmq.common.protocol.header.UpdateGlobalWhiteAddrsConfigRequestHeader;
import org.apache.rocketmq.common.protocol.header.UpdateGroupForbiddenRequestHeader;
import org.apache.rocketmq.common.protocol.header.ViewBrokerStatsDataRequestHeader;
import org.apache.rocketmq.common.protocol.header.ViewMessageRequestHeader;
import org.apache.rocketmq.common.protocol.header.filtersrv.RegisterMessageFilterClassRequestHeader;
import org.apache.rocketmq.common.protocol.header.namesrv.AddWritePermOfBrokerRequestHeader;
import org.apache.rocketmq.common.protocol.header.namesrv.AddWritePermOfBrokerResponseHeader;
import org.apache.rocketmq.common.protocol.header.namesrv.DeleteKVConfigRequestHeader;
import org.apache.rocketmq.common.protocol.header.namesrv.DeleteTopicFromNamesrvRequestHeader;
import org.apache.rocketmq.common.protocol.header.namesrv.GetKVConfigRequestHeader;
import org.apache.rocketmq.common.protocol.header.namesrv.GetKVConfigResponseHeader;
import org.apache.rocketmq.common.protocol.header.namesrv.GetKVListByNamespaceRequestHeader;
import org.apache.rocketmq.common.protocol.header.namesrv.GetRouteInfoRequestHeader;
import org.apache.rocketmq.common.protocol.header.namesrv.PutKVConfigRequestHeader;
import org.apache.rocketmq.common.protocol.header.namesrv.WipeWritePermOfBrokerRequestHeader;
import org.apache.rocketmq.common.protocol.header.namesrv.WipeWritePermOfBrokerResponseHeader;
import org.apache.rocketmq.common.protocol.heartbeat.HeartbeatData;
import org.apache.rocketmq.common.protocol.heartbeat.MessageModel;
import org.apache.rocketmq.common.protocol.heartbeat.SubscriptionData;
import org.apache.rocketmq.common.protocol.route.TopicRouteData;
import org.apache.rocketmq.common.statictopic.TopicConfigAndQueueMapping;
import org.apache.rocketmq.common.statictopic.TopicQueueMappingDetail;
import org.apache.rocketmq.common.subscription.GroupForbidden;
import org.apache.rocketmq.common.rpchook.StreamTypeRPCHook;
import org.apache.rocketmq.common.subscription.SubscriptionGroupConfig;
import org.apache.rocketmq.common.sysflag.PullSysFlag;
import org.apache.rocketmq.logging.InternalLogger;
import org.apache.rocketmq.remoting.CommandCustomHeader;
import org.apache.rocketmq.remoting.InvokeCallback;
import org.apache.rocketmq.remoting.RPCHook;
import org.apache.rocketmq.remoting.RemotingClient;
import org.apache.rocketmq.remoting.common.RemotingHelper;
import org.apache.rocketmq.remoting.exception.RemotingCommandException;
import org.apache.rocketmq.remoting.exception.RemotingConnectException;
import org.apache.rocketmq.remoting.exception.RemotingException;
import org.apache.rocketmq.remoting.exception.RemotingSendRequestException;
import org.apache.rocketmq.remoting.exception.RemotingTimeoutException;
import org.apache.rocketmq.remoting.exception.RemotingTooMuchRequestException;
import org.apache.rocketmq.remoting.netty.NettyClientConfig;
import org.apache.rocketmq.remoting.netty.NettyRemotingClient;
import org.apache.rocketmq.remoting.netty.ResponseFuture;
import org.apache.rocketmq.remoting.protocol.LanguageCode;
import org.apache.rocketmq.remoting.protocol.RemotingCommand;
import org.apache.rocketmq.remoting.protocol.RemotingSerializable;

<span class="pc bpc" id="L213" title="1 of 2 branches missed.">public class MQClientAPIImpl implements NameServerUpdateCallback {</span>
<span class="fc" id="L214">    private final static InternalLogger log = ClientLogger.getLog();</span>
<span class="fc" id="L215">    private static boolean sendSmartMsg =</span>
<span class="fc" id="L216">        Boolean.parseBoolean(System.getProperty(&quot;org.apache.rocketmq.client.sendSmartMsg&quot;, &quot;true&quot;));</span>

    static {
<span class="fc" id="L219">        System.setProperty(RemotingCommand.REMOTING_VERSION_KEY, Integer.toString(MQVersion.CURRENT_VERSION));</span>
<span class="fc" id="L220">    }</span>

    private final RemotingClient remotingClient;
    private final TopAddressing topAddressing;
    private final ClientRemotingProcessor clientRemotingProcessor;
<span class="fc" id="L225">    private String nameSrvAddr = null;</span>
    private ClientConfig clientConfig;

    public MQClientAPIImpl(final NettyClientConfig nettyClientConfig,
        final ClientRemotingProcessor clientRemotingProcessor,
<span class="fc" id="L230">        RPCHook rpcHook, final ClientConfig clientConfig) {</span>
<span class="fc" id="L231">        this.clientConfig = clientConfig;</span>
<span class="fc" id="L232">        topAddressing = new DefaultTopAddressing(MixAll.getWSAddr(), clientConfig.getUnitName());</span>
<span class="fc" id="L233">        topAddressing.registerChangeCallBack(this);</span>
<span class="fc" id="L234">        this.remotingClient = new NettyRemotingClient(nettyClientConfig, null);</span>
<span class="fc" id="L235">        this.clientRemotingProcessor = clientRemotingProcessor;</span>

        // Inject stream rpc hook first to make reserve field signature
<span class="fc bfc" id="L238" title="All 2 branches covered.">        if (clientConfig.isEnableStreamRequestType()) {</span>
<span class="fc" id="L239">            this.remotingClient.registerRPCHook(new StreamTypeRPCHook());</span>
        }
<span class="fc" id="L241">        this.remotingClient.registerRPCHook(rpcHook);</span>
<span class="fc" id="L242">        this.remotingClient.registerProcessor(RequestCode.CHECK_TRANSACTION_STATE, this.clientRemotingProcessor, null);</span>

<span class="fc" id="L244">        this.remotingClient.registerProcessor(RequestCode.NOTIFY_CONSUMER_IDS_CHANGED, this.clientRemotingProcessor, null);</span>

<span class="fc" id="L246">        this.remotingClient.registerProcessor(RequestCode.RESET_CONSUMER_CLIENT_OFFSET, this.clientRemotingProcessor, null);</span>

<span class="fc" id="L248">        this.remotingClient.registerProcessor(RequestCode.GET_CONSUMER_STATUS_FROM_CLIENT, this.clientRemotingProcessor, null);</span>

<span class="fc" id="L250">        this.remotingClient.registerProcessor(RequestCode.GET_CONSUMER_RUNNING_INFO, this.clientRemotingProcessor, null);</span>

<span class="fc" id="L252">        this.remotingClient.registerProcessor(RequestCode.CONSUME_MESSAGE_DIRECTLY, this.clientRemotingProcessor, null);</span>

<span class="fc" id="L254">        this.remotingClient.registerProcessor(RequestCode.PUSH_REPLY_MESSAGE_TO_CLIENT, this.clientRemotingProcessor, null);</span>
<span class="fc" id="L255">    }</span>

    public List&lt;String&gt; getNameServerAddressList() {
<span class="nc" id="L258">        return this.remotingClient.getNameServerAddressList();</span>
    }

    public RemotingClient getRemotingClient() {
<span class="fc" id="L262">        return remotingClient;</span>
    }

    public String fetchNameServerAddr() {
        try {
<span class="fc" id="L267">            String addrs = this.topAddressing.fetchNSAddr();</span>
<span class="pc bpc" id="L268" title="1 of 2 branches missed.">            if (!UtilAll.isBlank(addrs)) {</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">                if (!addrs.equals(this.nameSrvAddr)) {</span>
<span class="nc" id="L270">                    log.info(&quot;name server address changed, old=&quot; + this.nameSrvAddr + &quot;, new=&quot; + addrs);</span>
<span class="nc" id="L271">                    this.updateNameServerAddressList(addrs);</span>
<span class="nc" id="L272">                    this.nameSrvAddr = addrs;</span>
<span class="nc" id="L273">                    return nameSrvAddr;</span>
                }
            }
<span class="nc" id="L276">        } catch (Exception e) {</span>
<span class="nc" id="L277">            log.error(&quot;fetchNameServerAddr Exception&quot;, e);</span>
<span class="fc" id="L278">        }</span>
<span class="fc" id="L279">        return nameSrvAddr;</span>
    }

    @Override
    public String onNameServerAddressChange(String namesrvAddress) {
<span class="nc bnc" id="L284" title="All 2 branches missed.">        if (namesrvAddress != null) {</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">            if (!namesrvAddress.equals(this.nameSrvAddr)) {</span>
<span class="nc" id="L286">                log.info(&quot;name server address changed, old=&quot; + this.nameSrvAddr + &quot;, new=&quot; + namesrvAddress);</span>
<span class="nc" id="L287">                this.updateNameServerAddressList(namesrvAddress);</span>
<span class="nc" id="L288">                this.nameSrvAddr = namesrvAddress;</span>
<span class="nc" id="L289">                return nameSrvAddr;</span>
            }
        }
<span class="nc" id="L292">        return nameSrvAddr;</span>
    }

    public void updateNameServerAddressList(final String addrs) {
<span class="fc" id="L296">        String[] addrArray = addrs.split(&quot;;&quot;);</span>
<span class="fc" id="L297">        List&lt;String&gt; list = Arrays.asList(addrArray);</span>
<span class="fc" id="L298">        this.remotingClient.updateNameServerAddressList(list);</span>
<span class="fc" id="L299">    }</span>

    public void start() {
<span class="fc" id="L302">        this.remotingClient.start();</span>
<span class="fc" id="L303">    }</span>

    public void shutdown() {
<span class="fc" id="L306">        this.remotingClient.shutdown();</span>
<span class="fc" id="L307">    }</span>

    public Set&lt;MessageQueueAssignment&gt; queryAssignment(final String addr, final String topic,
        final String consumerGroup, final String clientId, final String strategyName,
        final MessageModel messageModel, final long timeoutMillis)
        throws RemotingException, MQBrokerException, InterruptedException {
<span class="fc" id="L313">        QueryAssignmentRequestBody requestBody = new QueryAssignmentRequestBody();</span>
<span class="fc" id="L314">        requestBody.setTopic(topic);</span>
<span class="fc" id="L315">        requestBody.setConsumerGroup(consumerGroup);</span>
<span class="fc" id="L316">        requestBody.setClientId(clientId);</span>
<span class="fc" id="L317">        requestBody.setMessageModel(messageModel);</span>
<span class="fc" id="L318">        requestBody.setStrategyName(strategyName);</span>

<span class="fc" id="L320">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.QUERY_ASSIGNMENT, null);</span>
<span class="fc" id="L321">        request.setBody(requestBody.encode());</span>

<span class="fc" id="L323">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="pc bpc" id="L325" title="1 of 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="fc" id="L327">                QueryAssignmentResponseBody queryAssignmentResponseBody = QueryAssignmentResponseBody.decode(response.getBody(), QueryAssignmentResponseBody.class);</span>
<span class="fc" id="L328">                return queryAssignmentResponseBody.getMessageQueueAssignments();</span>
            }
            default:
                break;
        }

<span class="nc" id="L334">        throw new MQBrokerException(response.getCode(), response.getRemark());</span>
    }

    public void createSubscriptionGroup(final String addr, final SubscriptionGroupConfig config,
        final long timeoutMillis) throws RemotingException, InterruptedException, MQClientException {
<span class="fc" id="L339">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.UPDATE_AND_CREATE_SUBSCRIPTIONGROUP, null);</span>

<span class="fc" id="L341">        byte[] body = RemotingSerializable.encode(config);</span>
<span class="fc" id="L342">        request.setBody(body);</span>

<span class="fc" id="L344">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="pc bpc" id="L346" title="2 of 4 branches missed.">        assert response != null;</span>
<span class="pc bpc" id="L347" title="1 of 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="fc" id="L349">                return;</span>
            }
            default:
                break;
        }

<span class="nc" id="L355">        throw new MQClientException(response.getCode(), response.getRemark());</span>

    }

    public void createTopic(final String addr, final String defaultTopic, final TopicConfig topicConfig,
        final long timeoutMillis)
        throws RemotingException, InterruptedException, MQClientException {
<span class="fc" id="L362">        CreateTopicRequestHeader requestHeader = new CreateTopicRequestHeader();</span>
<span class="fc" id="L363">        requestHeader.setTopic(topicConfig.getTopicName());</span>
<span class="fc" id="L364">        requestHeader.setDefaultTopic(defaultTopic);</span>
<span class="fc" id="L365">        requestHeader.setReadQueueNums(topicConfig.getReadQueueNums());</span>
<span class="fc" id="L366">        requestHeader.setWriteQueueNums(topicConfig.getWriteQueueNums());</span>
<span class="fc" id="L367">        requestHeader.setPerm(topicConfig.getPerm());</span>
<span class="fc" id="L368">        requestHeader.setTopicFilterType(topicConfig.getTopicFilterType().name());</span>
<span class="fc" id="L369">        requestHeader.setTopicSysFlag(topicConfig.getTopicSysFlag());</span>
<span class="fc" id="L370">        requestHeader.setOrder(topicConfig.isOrder());</span>
<span class="fc" id="L371">        requestHeader.setAttributes(AttributeParser.parseToString(topicConfig.getAttributes()));</span>

<span class="fc" id="L373">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.UPDATE_AND_CREATE_TOPIC, requestHeader);</span>

<span class="fc" id="L375">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="pc bpc" id="L377" title="2 of 4 branches missed.">        assert response != null;</span>
<span class="pc bpc" id="L378" title="1 of 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="fc" id="L380">                return;</span>
            }
            default:
                break;
        }

<span class="nc" id="L386">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public void createPlainAccessConfig(final String addr, final PlainAccessConfig plainAccessConfig,
        final long timeoutMillis)
        throws RemotingException, InterruptedException, MQClientException {
<span class="fc" id="L392">        CreateAccessConfigRequestHeader requestHeader = new CreateAccessConfigRequestHeader();</span>
<span class="fc" id="L393">        requestHeader.setAccessKey(plainAccessConfig.getAccessKey());</span>
<span class="fc" id="L394">        requestHeader.setSecretKey(plainAccessConfig.getSecretKey());</span>
<span class="fc" id="L395">        requestHeader.setAdmin(plainAccessConfig.isAdmin());</span>
<span class="fc" id="L396">        requestHeader.setDefaultGroupPerm(plainAccessConfig.getDefaultGroupPerm());</span>
<span class="fc" id="L397">        requestHeader.setDefaultTopicPerm(plainAccessConfig.getDefaultTopicPerm());</span>
<span class="fc" id="L398">        requestHeader.setWhiteRemoteAddress(plainAccessConfig.getWhiteRemoteAddress());</span>
<span class="fc" id="L399">        requestHeader.setTopicPerms(UtilAll.join(plainAccessConfig.getTopicPerms(), &quot;,&quot;));</span>
<span class="fc" id="L400">        requestHeader.setGroupPerms(UtilAll.join(plainAccessConfig.getGroupPerms(), &quot;,&quot;));</span>

<span class="fc" id="L402">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.UPDATE_AND_CREATE_ACL_CONFIG, requestHeader);</span>

<span class="fc" id="L404">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="pc bpc" id="L406" title="2 of 4 branches missed.">        assert response != null;</span>
<span class="fc bfc" id="L407" title="All 2 branches covered.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="fc" id="L409">                return;</span>
            }
            default:
                break;
        }

<span class="fc" id="L415">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public void deleteAccessConfig(final String addr, final String accessKey, final long timeoutMillis)
        throws RemotingException, InterruptedException, MQClientException {
<span class="fc" id="L420">        DeleteAccessConfigRequestHeader requestHeader = new DeleteAccessConfigRequestHeader();</span>
<span class="fc" id="L421">        requestHeader.setAccessKey(accessKey);</span>

<span class="fc" id="L423">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.DELETE_ACL_CONFIG, requestHeader);</span>

<span class="fc" id="L425">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="pc bpc" id="L427" title="2 of 4 branches missed.">        assert response != null;</span>
<span class="fc bfc" id="L428" title="All 2 branches covered.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="fc" id="L430">                return;</span>
            }
            default:
                break;
        }

<span class="fc" id="L436">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public void updateGlobalWhiteAddrsConfig(final String addr, final String globalWhiteAddrs, String aclFileFullPath, final long timeoutMillis)
        throws RemotingException, MQBrokerException, InterruptedException, MQClientException {
<span class="nc" id="L441">        UpdateGlobalWhiteAddrsConfigRequestHeader requestHeader = new UpdateGlobalWhiteAddrsConfigRequestHeader();</span>
<span class="nc" id="L442">        requestHeader.setGlobalWhiteAddrs(globalWhiteAddrs);</span>
<span class="nc" id="L443">        requestHeader.setAclFileFullPath(aclFileFullPath);</span>

<span class="nc" id="L445">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.UPDATE_GLOBAL_WHITE_ADDRS_CONFIG, requestHeader);</span>

<span class="nc" id="L447">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L449" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L450" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L452">                return;</span>
            }
            default:
                break;
        }

<span class="nc" id="L458">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public ClusterAclVersionInfo getBrokerClusterAclInfo(final String addr,
        final long timeoutMillis) throws RemotingCommandException, InterruptedException, RemotingTimeoutException,
        RemotingSendRequestException, RemotingConnectException, MQBrokerException {
<span class="nc" id="L464">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_BROKER_CLUSTER_ACL_INFO, null);</span>

<span class="nc" id="L466">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr), request, timeoutMillis);</span>
<span class="nc bnc" id="L467" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L468" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L470">                GetBrokerAclConfigResponseHeader responseHeader =</span>
<span class="nc" id="L471">                    (GetBrokerAclConfigResponseHeader) response.decodeCommandCustomHeader(GetBrokerAclConfigResponseHeader.class);</span>

<span class="nc" id="L473">                ClusterAclVersionInfo clusterAclVersionInfo = new ClusterAclVersionInfo();</span>
<span class="nc" id="L474">                clusterAclVersionInfo.setClusterName(responseHeader.getClusterName());</span>
<span class="nc" id="L475">                clusterAclVersionInfo.setBrokerName(responseHeader.getBrokerName());</span>
<span class="nc" id="L476">                clusterAclVersionInfo.setBrokerAddr(responseHeader.getBrokerAddr());</span>
<span class="nc" id="L477">                clusterAclVersionInfo.setAclConfigDataVersion(DataVersion.fromJson(responseHeader.getVersion(), DataVersion.class));</span>
<span class="nc" id="L478">                HashMap&lt;String, Object&gt; dataVersionMap = JSON.parseObject(responseHeader.getAllAclFileVersion(), HashMap.class);</span>
<span class="nc" id="L479">                Map&lt;String, DataVersion&gt; allAclConfigDataVersion = new HashMap&lt;String, DataVersion&gt;(dataVersionMap.size(), 1);</span>
<span class="nc bnc" id="L480" title="All 2 branches missed.">                for (Map.Entry&lt;String, Object&gt; entry : dataVersionMap.entrySet()) {</span>
<span class="nc" id="L481">                    allAclConfigDataVersion.put(entry.getKey(), DataVersion.fromJson(JSON.toJSONString(entry.getValue()), DataVersion.class));</span>
<span class="nc" id="L482">                }</span>
<span class="nc" id="L483">                clusterAclVersionInfo.setAllAclConfigDataVersion(allAclConfigDataVersion);</span>
<span class="nc" id="L484">                return clusterAclVersionInfo;</span>
            }
            default:
                break;
        }

<span class="nc" id="L490">        throw new MQBrokerException(response.getCode(), response.getRemark(), addr);</span>

    }

    public AclConfig getBrokerClusterConfig(final String addr,
        final long timeoutMillis) throws InterruptedException, RemotingTimeoutException,
        RemotingSendRequestException, RemotingConnectException, MQBrokerException {
<span class="fc" id="L497">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_BROKER_CLUSTER_ACL_CONFIG, null);</span>

<span class="fc" id="L499">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr), request, timeoutMillis);</span>
<span class="pc bpc" id="L500" title="2 of 4 branches missed.">        assert response != null;</span>
<span class="pc bpc" id="L501" title="1 of 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="pc bpc" id="L503" title="1 of 2 branches missed.">                if (response.getBody() != null) {</span>
<span class="fc" id="L504">                    GetBrokerClusterAclConfigResponseBody body =</span>
<span class="fc" id="L505">                        GetBrokerClusterAclConfigResponseBody.decode(response.getBody(), GetBrokerClusterAclConfigResponseBody.class);</span>
<span class="fc" id="L506">                    AclConfig aclConfig = new AclConfig();</span>
<span class="fc" id="L507">                    aclConfig.setGlobalWhiteAddrs(body.getGlobalWhiteAddrs());</span>
<span class="fc" id="L508">                    aclConfig.setPlainAccessConfigs(body.getPlainAccessConfigs());</span>
<span class="fc" id="L509">                    return aclConfig;</span>
                }
            }
            default:
                break;
        }
<span class="nc" id="L515">        throw new MQBrokerException(response.getCode(), response.getRemark(), addr);</span>

    }

    public SendResult sendMessage(
        final String addr,
        final String brokerName,
        final Message msg,
        final SendMessageRequestHeader requestHeader,
        final long timeoutMillis,
        final CommunicationMode communicationMode,
        final SendMessageContext context,
        final DefaultMQProducerImpl producer
    ) throws RemotingException, MQBrokerException, InterruptedException {
<span class="fc" id="L529">        return sendMessage(addr, brokerName, msg, requestHeader, timeoutMillis, communicationMode, null, null, null, 0, context, producer);</span>
    }

    public SendResult sendMessage(
        final String addr,
        final String brokerName,
        final Message msg,
        final SendMessageRequestHeader requestHeader,
        final long timeoutMillis,
        final CommunicationMode communicationMode,
        final SendCallback sendCallback,
        final TopicPublishInfo topicPublishInfo,
        final MQClientInstance instance,
        final int retryTimesWhenSendFailed,
        final SendMessageContext context,
        final DefaultMQProducerImpl producer
    ) throws RemotingException, MQBrokerException, InterruptedException {
<span class="fc" id="L546">        long beginStartTime = System.currentTimeMillis();</span>
<span class="fc" id="L547">        RemotingCommand request = null;</span>
<span class="fc" id="L548">        String msgType = msg.getProperty(MessageConst.PROPERTY_MESSAGE_TYPE);</span>
<span class="pc bpc" id="L549" title="1 of 4 branches missed.">        boolean isReply = msgType != null &amp;&amp; msgType.equals(MixAll.REPLY_MESSAGE_FLAG);</span>
<span class="fc bfc" id="L550" title="All 2 branches covered.">        if (isReply) {</span>
<span class="pc bpc" id="L551" title="1 of 2 branches missed.">            if (sendSmartMsg) {</span>
<span class="fc" id="L552">                SendMessageRequestHeaderV2 requestHeaderV2 = SendMessageRequestHeaderV2.createSendMessageRequestHeaderV2(requestHeader);</span>
<span class="fc" id="L553">                request = RemotingCommand.createRequestCommand(RequestCode.SEND_REPLY_MESSAGE_V2, requestHeaderV2);</span>
<span class="fc" id="L554">            } else {</span>
<span class="nc" id="L555">                request = RemotingCommand.createRequestCommand(RequestCode.SEND_REPLY_MESSAGE, requestHeader);</span>
            }
        } else {
<span class="pc bpc" id="L558" title="3 of 4 branches missed.">            if (sendSmartMsg || msg instanceof MessageBatch) {</span>
<span class="fc" id="L559">                SendMessageRequestHeaderV2 requestHeaderV2 = SendMessageRequestHeaderV2.createSendMessageRequestHeaderV2(requestHeader);</span>
<span class="pc bpc" id="L560" title="1 of 2 branches missed.">                request = RemotingCommand.createRequestCommand(msg instanceof MessageBatch ? RequestCode.SEND_BATCH_MESSAGE : RequestCode.SEND_MESSAGE_V2, requestHeaderV2);</span>
<span class="fc" id="L561">            } else {</span>
<span class="nc" id="L562">                request = RemotingCommand.createRequestCommand(RequestCode.SEND_MESSAGE, requestHeader);</span>
            }
        }
<span class="fc" id="L565">        request.setBody(msg.getBody());</span>

<span class="pc bpc" id="L567" title="1 of 4 branches missed.">        switch (communicationMode) {</span>
            case ONEWAY:
<span class="fc" id="L569">                this.remotingClient.invokeOneway(addr, request, timeoutMillis);</span>
<span class="fc" id="L570">                return null;</span>
            case ASYNC:
<span class="fc" id="L572">                final AtomicInteger times = new AtomicInteger();</span>
<span class="fc" id="L573">                long costTimeAsync = System.currentTimeMillis() - beginStartTime;</span>
<span class="pc bpc" id="L574" title="1 of 2 branches missed.">                if (timeoutMillis &lt; costTimeAsync) {</span>
<span class="nc" id="L575">                    throw new RemotingTooMuchRequestException(&quot;sendMessage call timeout&quot;);</span>
                }
<span class="fc" id="L577">                this.sendMessageAsync(addr, brokerName, msg, timeoutMillis - costTimeAsync, request, sendCallback, topicPublishInfo, instance,</span>
                    retryTimesWhenSendFailed, times, context, producer);
<span class="fc" id="L579">                return null;</span>
            case SYNC:
<span class="fc" id="L581">                long costTimeSync = System.currentTimeMillis() - beginStartTime;</span>
<span class="pc bpc" id="L582" title="1 of 2 branches missed.">                if (timeoutMillis &lt; costTimeSync) {</span>
<span class="nc" id="L583">                    throw new RemotingTooMuchRequestException(&quot;sendMessage call timeout&quot;);</span>
                }
<span class="fc" id="L585">                return this.sendMessageSync(addr, brokerName, msg, timeoutMillis - costTimeSync, request);</span>
            default:
<span class="nc bnc" id="L587" title="All 2 branches missed.">                assert false;</span>
                break;
        }

<span class="nc" id="L591">        return null;</span>
    }

    private SendResult sendMessageSync(
        final String addr,
        final String brokerName,
        final Message msg,
        final long timeoutMillis,
        final RemotingCommand request
    ) throws RemotingException, MQBrokerException, InterruptedException {
<span class="fc" id="L601">        RemotingCommand response = this.remotingClient.invokeSync(addr, request, timeoutMillis);</span>
<span class="pc bpc" id="L602" title="2 of 4 branches missed.">        assert response != null;</span>
<span class="fc" id="L603">        return this.processSendResponse(brokerName, msg, response, addr);</span>
    }

    void execRpcHooksAfterRequest(ResponseFuture responseFuture) {
<span class="pc bpc" id="L607" title="1 of 2 branches missed.">        if (this.remotingClient instanceof NettyRemotingClient) {</span>
<span class="nc" id="L608">            NettyRemotingClient remotingClient = (NettyRemotingClient) this.remotingClient;</span>
<span class="nc" id="L609">            RemotingCommand response = responseFuture.getResponseCommand();</span>
<span class="nc" id="L610">            remotingClient.doAfterRpcHooks(RemotingHelper.parseChannelRemoteAddr(responseFuture.getChannel()), responseFuture.getRequestCommand(), response);</span>
        }
<span class="fc" id="L612">    }</span>

    private void sendMessageAsync(
        final String addr,
        final String brokerName,
        final Message msg,
        final long timeoutMillis,
        final RemotingCommand request,
        final SendCallback sendCallback,
        final TopicPublishInfo topicPublishInfo,
        final MQClientInstance instance,
        final int retryTimesWhenSendFailed,
        final AtomicInteger times,
        final SendMessageContext context,
        final DefaultMQProducerImpl producer
    ) {
<span class="fc" id="L628">        final long beginStartTime = System.currentTimeMillis();</span>
        try {
<span class="pc bpc" id="L630" title="1 of 2 branches missed.">            this.remotingClient.invokeAsync(addr, request, timeoutMillis, new InvokeCallback() {</span>
                @Override
                public void operationComplete(ResponseFuture responseFuture) {
<span class="fc" id="L633">                    long cost = System.currentTimeMillis() - beginStartTime;</span>
<span class="fc" id="L634">                    RemotingCommand response = responseFuture.getResponseCommand();</span>
<span class="pc bpc" id="L635" title="3 of 4 branches missed.">                    if (null == sendCallback &amp;&amp; response != null) {</span>

                        try {
<span class="nc" id="L638">                            SendResult sendResult = MQClientAPIImpl.this.processSendResponse(brokerName, msg, response, addr);</span>
<span class="nc bnc" id="L639" title="All 4 branches missed.">                            if (context != null &amp;&amp; sendResult != null) {</span>
<span class="nc" id="L640">                                context.setSendResult(sendResult);</span>
<span class="nc" id="L641">                                context.getProducer().executeSendMessageHookAfter(context);</span>
                            }
<span class="nc" id="L643">                        } catch (Throwable e) {</span>
<span class="nc" id="L644">                        }</span>

<span class="nc" id="L646">                        producer.updateFaultItem(brokerName, System.currentTimeMillis() - responseFuture.getBeginTimestamp(), false);</span>
<span class="nc" id="L647">                        return;</span>
                    }

<span class="pc bpc" id="L650" title="1 of 2 branches missed.">                    if (response != null) {</span>
                        try {
<span class="fc" id="L652">                            SendResult sendResult = MQClientAPIImpl.this.processSendResponse(brokerName, msg, response, addr);</span>
<span class="pc bpc" id="L653" title="2 of 4 branches missed.">                            assert sendResult != null;</span>
<span class="pc bpc" id="L654" title="1 of 2 branches missed.">                            if (context != null) {</span>
<span class="fc" id="L655">                                context.setSendResult(sendResult);</span>
<span class="fc" id="L656">                                context.getProducer().executeSendMessageHookAfter(context);</span>
                            }

                            try {
<span class="fc" id="L660">                                sendCallback.onSuccess(sendResult);</span>
<span class="nc" id="L661">                            } catch (Throwable e) {</span>
<span class="fc" id="L662">                            }</span>

<span class="fc" id="L664">                            producer.updateFaultItem(brokerName, System.currentTimeMillis() - responseFuture.getBeginTimestamp(), false);</span>
<span class="nc" id="L665">                        } catch (Exception e) {</span>
<span class="nc" id="L666">                            producer.updateFaultItem(brokerName, System.currentTimeMillis() - responseFuture.getBeginTimestamp(), true);</span>
<span class="nc" id="L667">                            onExceptionImpl(brokerName, msg, timeoutMillis - cost, request, sendCallback, topicPublishInfo, instance,</span>
                                retryTimesWhenSendFailed, times, e, context, false, producer);
<span class="pc" id="L669">                        }</span>
                    } else {
<span class="nc" id="L671">                        producer.updateFaultItem(brokerName, System.currentTimeMillis() - responseFuture.getBeginTimestamp(), true);</span>
<span class="nc bnc" id="L672" title="All 2 branches missed.">                        if (!responseFuture.isSendRequestOK()) {</span>
<span class="nc" id="L673">                            MQClientException ex = new MQClientException(&quot;send request failed&quot;, responseFuture.getCause());</span>
<span class="nc" id="L674">                            onExceptionImpl(brokerName, msg, timeoutMillis - cost, request, sendCallback, topicPublishInfo, instance,</span>
                                retryTimesWhenSendFailed, times, ex, context, true, producer);
<span class="nc bnc" id="L676" title="All 2 branches missed.">                        } else if (responseFuture.isTimeout()) {</span>
<span class="nc" id="L677">                            MQClientException ex = new MQClientException(&quot;wait response timeout &quot; + responseFuture.getTimeoutMillis() + &quot;ms&quot;,</span>
<span class="nc" id="L678">                                responseFuture.getCause());</span>
<span class="nc" id="L679">                            onExceptionImpl(brokerName, msg, timeoutMillis - cost, request, sendCallback, topicPublishInfo, instance,</span>
                                retryTimesWhenSendFailed, times, ex, context, true, producer);
<span class="nc" id="L681">                        } else {</span>
<span class="nc" id="L682">                            MQClientException ex = new MQClientException(&quot;unknow reseaon&quot;, responseFuture.getCause());</span>
<span class="nc" id="L683">                            onExceptionImpl(brokerName, msg, timeoutMillis - cost, request, sendCallback, topicPublishInfo, instance,</span>
                                retryTimesWhenSendFailed, times, ex, context, true, producer);
                        }
                    }
<span class="fc" id="L687">                }</span>
            });
<span class="fc" id="L689">        } catch (Exception ex) {</span>
<span class="fc" id="L690">            long cost = System.currentTimeMillis() - beginStartTime;</span>
<span class="fc" id="L691">            producer.updateFaultItem(brokerName, cost, true);</span>
<span class="fc" id="L692">            onExceptionImpl(brokerName, msg, timeoutMillis - cost, request, sendCallback, topicPublishInfo, instance,</span>
                retryTimesWhenSendFailed, times, ex, context, true, producer);
<span class="fc" id="L694">        }</span>
<span class="fc" id="L695">    }</span>

    private void onExceptionImpl(final String brokerName,
        final Message msg,
        final long timeoutMillis,
        final RemotingCommand request,
        final SendCallback sendCallback,
        final TopicPublishInfo topicPublishInfo,
        final MQClientInstance instance,
        final int timesTotal,
        final AtomicInteger curTimes,
        final Exception e,
        final SendMessageContext context,
        final boolean needRetry,
        final DefaultMQProducerImpl producer
    ) {
<span class="fc" id="L711">        int tmp = curTimes.incrementAndGet();</span>
<span class="pc bpc" id="L712" title="2 of 4 branches missed.">        if (needRetry &amp;&amp; tmp &lt;= timesTotal) {</span>
<span class="nc" id="L713">            String retryBrokerName = brokerName;//by default, it will send to the same broker</span>
<span class="nc bnc" id="L714" title="All 2 branches missed.">            if (topicPublishInfo != null) { //select one message queue accordingly, in order to determine which broker to send</span>
<span class="nc" id="L715">                MessageQueue mqChosen = producer.selectOneMessageQueue(topicPublishInfo, brokerName);</span>
<span class="nc" id="L716">                retryBrokerName = instance.getBrokerNameFromMessageQueue(mqChosen);</span>
            }
<span class="nc" id="L718">            String addr = instance.findBrokerAddressInPublish(retryBrokerName);</span>
<span class="nc" id="L719">            log.warn(&quot;async send msg by retry {} times. topic={}, brokerAddr={}, brokerName={}&quot;, tmp, msg.getTopic(), addr,</span>
                retryBrokerName, e);
<span class="nc" id="L721">            request.setOpaque(RemotingCommand.createNewRequestId());</span>
<span class="nc" id="L722">            sendMessageAsync(addr, retryBrokerName, msg, timeoutMillis, request, sendCallback, topicPublishInfo, instance,</span>
                timesTotal, curTimes, context, producer);
<span class="nc" id="L724">        } else {</span>

<span class="pc bpc" id="L726" title="1 of 2 branches missed.">            if (context != null) {</span>
<span class="fc" id="L727">                context.setException(e);</span>
<span class="fc" id="L728">                context.getProducer().executeSendMessageHookAfter(context);</span>
            }

            try {
<span class="fc" id="L732">                sendCallback.onException(e);</span>
<span class="nc" id="L733">            } catch (Exception ignored) {</span>
<span class="fc" id="L734">            }</span>
        }
<span class="fc" id="L736">    }</span>

    private SendResult processSendResponse(
        final String brokerName,
        final Message msg,
        final RemotingCommand response,
        final String addr
    ) throws MQBrokerException, RemotingCommandException {
        SendStatus sendStatus;
<span class="pc bpc" id="L745" title="3 of 5 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.FLUSH_DISK_TIMEOUT: {
<span class="nc" id="L747">                sendStatus = SendStatus.FLUSH_DISK_TIMEOUT;</span>
<span class="nc" id="L748">                break;</span>
            }
            case ResponseCode.FLUSH_SLAVE_TIMEOUT: {
<span class="nc" id="L751">                sendStatus = SendStatus.FLUSH_SLAVE_TIMEOUT;</span>
<span class="nc" id="L752">                break;</span>
            }
            case ResponseCode.SLAVE_NOT_AVAILABLE: {
<span class="nc" id="L755">                sendStatus = SendStatus.SLAVE_NOT_AVAILABLE;</span>
<span class="nc" id="L756">                break;</span>
            }
            case ResponseCode.SUCCESS: {
<span class="fc" id="L759">                sendStatus = SendStatus.SEND_OK;</span>
<span class="fc" id="L760">                break;</span>
            }
            default: {
<span class="fc" id="L763">                throw new MQBrokerException(response.getCode(), response.getRemark(), addr);</span>
            }
        }

<span class="fc" id="L767">        SendMessageResponseHeader responseHeader =</span>
<span class="fc" id="L768">            (SendMessageResponseHeader) response.decodeCommandCustomHeader(SendMessageResponseHeader.class);</span>

        //If namespace not null , reset Topic without namespace.
<span class="fc" id="L771">        String topic = msg.getTopic();</span>
<span class="pc bpc" id="L772" title="1 of 2 branches missed.">        if (StringUtils.isNotEmpty(this.clientConfig.getNamespace())) {</span>
<span class="nc" id="L773">            topic = NamespaceUtil.withoutNamespace(topic, this.clientConfig.getNamespace());</span>
        }

<span class="fc" id="L776">        MessageQueue messageQueue = new MessageQueue(topic, brokerName, responseHeader.getQueueId());</span>

<span class="fc" id="L778">        String uniqMsgId = MessageClientIDSetter.getUniqID(msg);</span>
<span class="pc bpc" id="L779" title="3 of 4 branches missed.">        if (msg instanceof MessageBatch &amp;&amp; responseHeader.getBatchUniqId() == null) {</span>
            // This means it is not an inner batch
<span class="nc" id="L781">            StringBuilder sb = new StringBuilder();</span>
<span class="nc bnc" id="L782" title="All 2 branches missed.">            for (Message message : (MessageBatch) msg) {</span>
<span class="nc bnc" id="L783" title="All 2 branches missed.">                sb.append(sb.length() == 0 ? &quot;&quot; : &quot;,&quot;).append(MessageClientIDSetter.getUniqID(message));</span>
<span class="nc" id="L784">            }</span>
<span class="nc" id="L785">            uniqMsgId = sb.toString();</span>
        }
<span class="fc" id="L787">        SendResult sendResult = new SendResult(sendStatus,</span>
            uniqMsgId,
<span class="fc" id="L789">            responseHeader.getMsgId(), messageQueue, responseHeader.getQueueOffset());</span>
<span class="fc" id="L790">        sendResult.setTransactionId(responseHeader.getTransactionId());</span>
<span class="fc" id="L791">        String regionId = response.getExtFields().get(MessageConst.PROPERTY_MSG_REGION);</span>
<span class="fc" id="L792">        String traceOn = response.getExtFields().get(MessageConst.PROPERTY_TRACE_SWITCH);</span>
<span class="pc bpc" id="L793" title="2 of 4 branches missed.">        if (regionId == null || regionId.isEmpty()) {</span>
<span class="nc" id="L794">            regionId = MixAll.DEFAULT_TRACE_REGION_ID;</span>
        }
<span class="pc bpc" id="L796" title="2 of 4 branches missed.">        if (traceOn != null &amp;&amp; traceOn.equals(&quot;false&quot;)) {</span>
<span class="nc" id="L797">            sendResult.setTraceOn(false);</span>
        } else {
<span class="fc" id="L799">            sendResult.setTraceOn(true);</span>
        }
<span class="fc" id="L801">        sendResult.setRegionId(regionId);</span>
<span class="fc" id="L802">        return sendResult;</span>
    }

    public PullResult pullMessage(
        final String addr,
        final PullMessageRequestHeader requestHeader,
        final long timeoutMillis,
        final CommunicationMode communicationMode,
        final PullCallback pullCallback
    ) throws RemotingException, MQBrokerException, InterruptedException {
        RemotingCommand request;
<span class="nc bnc" id="L813" title="All 2 branches missed.">        if (PullSysFlag.hasLitePullFlag(requestHeader.getSysFlag())) {</span>
<span class="nc" id="L814">            request = RemotingCommand.createRequestCommand(RequestCode.LITE_PULL_MESSAGE, requestHeader);</span>
        } else {
<span class="nc" id="L816">            request = RemotingCommand.createRequestCommand(RequestCode.PULL_MESSAGE, requestHeader);</span>
        }

<span class="nc bnc" id="L819" title="All 4 branches missed.">        switch (communicationMode) {</span>
            case ONEWAY:
<span class="nc bnc" id="L821" title="All 2 branches missed.">                assert false;</span>
<span class="nc" id="L822">                return null;</span>
            case ASYNC:
<span class="nc" id="L824">                this.pullMessageAsync(addr, request, timeoutMillis, pullCallback);</span>
<span class="nc" id="L825">                return null;</span>
            case SYNC:
<span class="nc" id="L827">                return this.pullMessageSync(addr, request, timeoutMillis);</span>
            default:
<span class="nc bnc" id="L829" title="All 2 branches missed.">                assert false;</span>
                break;
        }

<span class="nc" id="L833">        return null;</span>
    }

    public void popMessageAsync(
        final String brokerName, final String addr, final PopMessageRequestHeader requestHeader,
        final long timeoutMillis, final PopCallback popCallback
    ) throws RemotingException, InterruptedException {
<span class="fc" id="L840">        final RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.POP_MESSAGE, requestHeader);</span>
<span class="pc bpc" id="L841" title="1 of 2 branches missed.">        this.remotingClient.invokeAsync(addr, request, timeoutMillis, new BaseInvokeCallback(MQClientAPIImpl.this) {</span>
            @Override
            public void onComplete(ResponseFuture responseFuture) {
<span class="fc" id="L844">                RemotingCommand response = responseFuture.getResponseCommand();</span>
<span class="pc bpc" id="L845" title="1 of 2 branches missed.">                if (response != null) {</span>
                    try {
                        PopResult
<span class="fc" id="L848">                            popResult = MQClientAPIImpl.this.processPopResponse(brokerName, response, requestHeader.getTopic(), requestHeader);</span>
<span class="pc bpc" id="L849" title="2 of 4 branches missed.">                        assert popResult != null;</span>
<span class="fc" id="L850">                        popCallback.onSuccess(popResult);</span>
<span class="nc" id="L851">                    } catch (Exception e) {</span>
<span class="nc" id="L852">                        popCallback.onException(e);</span>
<span class="pc" id="L853">                    }</span>
                } else {
<span class="nc bnc" id="L855" title="All 2 branches missed.">                    if (!responseFuture.isSendRequestOK()) {</span>
<span class="nc" id="L856">                        popCallback.onException(new MQClientException(&quot;send request failed to &quot; + addr + &quot;. Request: &quot; + request, responseFuture.getCause()));</span>
<span class="nc bnc" id="L857" title="All 2 branches missed.">                    } else if (responseFuture.isTimeout()) {</span>
<span class="nc" id="L858">                        popCallback.onException(new MQClientException(&quot;wait response from &quot; + addr + &quot; timeout :&quot; + responseFuture.getTimeoutMillis() + &quot;ms&quot; + &quot;. Request: &quot; + request,</span>
<span class="nc" id="L859">                            responseFuture.getCause()));</span>
                    } else {
<span class="nc" id="L861">                        popCallback.onException(new MQClientException(&quot;unknown reason. addr: &quot; + addr + &quot;, timeoutMillis: &quot; + timeoutMillis + &quot;. Request: &quot; + request, responseFuture.getCause()));</span>
                    }
                }
<span class="fc" id="L864">            }</span>
        });
<span class="fc" id="L866">    }</span>

    public void ackMessageAsync(
        final String addr,
        final long timeOut,
        final AckCallback ackCallback,
        final AckMessageRequestHeader requestHeader //
    ) throws RemotingException, MQBrokerException, InterruptedException {
<span class="fc" id="L874">        final RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.ACK_MESSAGE, requestHeader);</span>
<span class="pc bpc" id="L875" title="1 of 2 branches missed.">        this.remotingClient.invokeAsync(addr, request, timeOut, new BaseInvokeCallback(MQClientAPIImpl.this) {</span>

            @Override
            public void onComplete(ResponseFuture responseFuture) {
<span class="fc" id="L879">                RemotingCommand response = responseFuture.getResponseCommand();</span>
<span class="pc bpc" id="L880" title="1 of 2 branches missed.">                if (response != null) {</span>
                    try {
<span class="fc" id="L882">                        AckResult ackResult = new AckResult();</span>
<span class="pc bpc" id="L883" title="1 of 2 branches missed.">                        if (ResponseCode.SUCCESS == response.getCode()) {</span>
<span class="fc" id="L884">                            ackResult.setStatus(AckStatus.OK);</span>
                        } else {
<span class="nc" id="L886">                            ackResult.setStatus(AckStatus.NO_EXIST);</span>
                        }
<span class="pc bpc" id="L888" title="2 of 4 branches missed.">                        assert ackResult != null;</span>
<span class="fc" id="L889">                        ackCallback.onSuccess(ackResult);</span>
<span class="nc" id="L890">                    } catch (Exception e) {</span>
<span class="nc" id="L891">                        ackCallback.onException(e);</span>
<span class="pc" id="L892">                    }</span>
                } else {
<span class="nc bnc" id="L894" title="All 2 branches missed.">                    if (!responseFuture.isSendRequestOK()) {</span>
<span class="nc" id="L895">                        ackCallback.onException(new MQClientException(&quot;send request failed to &quot; + addr + &quot;. Request: &quot; + request, responseFuture.getCause()));</span>
<span class="nc bnc" id="L896" title="All 2 branches missed.">                    } else if (responseFuture.isTimeout()) {</span>
<span class="nc" id="L897">                        ackCallback.onException(new MQClientException(&quot;wait response from &quot; + addr + &quot; timeout :&quot; + responseFuture.getTimeoutMillis() + &quot;ms&quot; + &quot;. Request: &quot; + request,</span>
<span class="nc" id="L898">                            responseFuture.getCause()));</span>
                    } else {
<span class="nc" id="L900">                        ackCallback.onException(new MQClientException(&quot;unknown reason. addr: &quot; + addr + &quot;, timeoutMillis: &quot; + timeOut + &quot;. Request: &quot; + request, responseFuture.getCause()));</span>
                    }
                }

<span class="fc" id="L904">            }</span>
        });
<span class="fc" id="L906">    }</span>

    public void changeInvisibleTimeAsync(//
        final String brokerName,
        final String addr, //
        final ChangeInvisibleTimeRequestHeader requestHeader,//
        final long timeoutMillis,
        final AckCallback ackCallback
    ) throws RemotingException, MQBrokerException, InterruptedException {
<span class="fc" id="L915">        final RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.CHANGE_MESSAGE_INVISIBLETIME, requestHeader);</span>
<span class="pc bpc" id="L916" title="1 of 2 branches missed.">        this.remotingClient.invokeAsync(addr, request, timeoutMillis, new BaseInvokeCallback(MQClientAPIImpl.this) {</span>
            @Override
            public void onComplete(ResponseFuture responseFuture) {
<span class="fc" id="L919">                RemotingCommand response = responseFuture.getResponseCommand();</span>
<span class="pc bpc" id="L920" title="1 of 2 branches missed.">                if (response != null) {</span>
                    try {
<span class="fc" id="L922">                        ChangeInvisibleTimeResponseHeader responseHeader = (ChangeInvisibleTimeResponseHeader) response.decodeCommandCustomHeader(ChangeInvisibleTimeResponseHeader.class);</span>
<span class="fc" id="L923">                        AckResult ackResult = new AckResult();</span>
<span class="pc bpc" id="L924" title="1 of 2 branches missed.">                        if (ResponseCode.SUCCESS == response.getCode()) {</span>
<span class="fc" id="L925">                            ackResult.setStatus(AckStatus.OK);</span>
<span class="fc" id="L926">                            ackResult.setPopTime(responseHeader.getPopTime());</span>
<span class="fc" id="L927">                            ackResult.setExtraInfo(ExtraInfoUtil</span>
<span class="fc" id="L928">                                .buildExtraInfo(requestHeader.getOffset(), responseHeader.getPopTime(), responseHeader.getInvisibleTime(),</span>
<span class="fc" id="L929">                                    responseHeader.getReviveQid(), requestHeader.getTopic(), brokerName, requestHeader.getQueueId()) + MessageConst.KEY_SEPARATOR</span>
<span class="fc" id="L930">                                + requestHeader.getOffset());</span>
                        } else {
<span class="nc" id="L932">                            ackResult.setStatus(AckStatus.NO_EXIST);</span>
                        }
<span class="pc bpc" id="L934" title="2 of 4 branches missed.">                        assert ackResult != null;</span>
<span class="fc" id="L935">                        ackCallback.onSuccess(ackResult);</span>
<span class="nc" id="L936">                    } catch (Exception e) {</span>
<span class="nc" id="L937">                        ackCallback.onException(e);</span>
<span class="pc" id="L938">                    }</span>
                } else {
<span class="nc bnc" id="L940" title="All 2 branches missed.">                    if (!responseFuture.isSendRequestOK()) {</span>
<span class="nc" id="L941">                        ackCallback.onException(new MQClientException(&quot;send request failed to &quot; + addr + &quot;. Request: &quot; + request, responseFuture.getCause()));</span>
<span class="nc bnc" id="L942" title="All 2 branches missed.">                    } else if (responseFuture.isTimeout()) {</span>
<span class="nc" id="L943">                        ackCallback.onException(new MQClientException(&quot;wait response from &quot; + addr + &quot; timeout :&quot; + responseFuture.getTimeoutMillis() + &quot;ms&quot; + &quot;. Request: &quot; + request,</span>
<span class="nc" id="L944">                            responseFuture.getCause()));</span>
                    } else {
<span class="nc" id="L946">                        ackCallback.onException(new MQClientException(&quot;unknown reason. addr: &quot; + addr + &quot;, timeoutMillis: &quot; + timeoutMillis + &quot;. Request: &quot; + request, responseFuture.getCause()));</span>
                    }
                }
<span class="fc" id="L949">            }</span>
        });
<span class="fc" id="L951">    }</span>

    private void pullMessageAsync(
        final String addr,
        final RemotingCommand request,
        final long timeoutMillis,
        final PullCallback pullCallback
    ) throws RemotingException, InterruptedException {
<span class="nc bnc" id="L959" title="All 2 branches missed.">        this.remotingClient.invokeAsync(addr, request, timeoutMillis, new InvokeCallback() {</span>
            @Override
            public void operationComplete(ResponseFuture responseFuture) {
<span class="nc" id="L962">                RemotingCommand response = responseFuture.getResponseCommand();</span>
<span class="nc bnc" id="L963" title="All 2 branches missed.">                if (response != null) {</span>
                    try {
<span class="nc" id="L965">                        PullResult pullResult = MQClientAPIImpl.this.processPullResponse(response, addr);</span>
<span class="nc bnc" id="L966" title="All 4 branches missed.">                        assert pullResult != null;</span>
<span class="nc" id="L967">                        pullCallback.onSuccess(pullResult);</span>
<span class="nc" id="L968">                    } catch (Exception e) {</span>
<span class="nc" id="L969">                        pullCallback.onException(e);</span>
<span class="nc" id="L970">                    }</span>
                } else {
<span class="nc bnc" id="L972" title="All 2 branches missed.">                    if (!responseFuture.isSendRequestOK()) {</span>
<span class="nc" id="L973">                        pullCallback.onException(new MQClientException(&quot;send request failed to &quot; + addr + &quot;. Request: &quot; + request, responseFuture.getCause()));</span>
<span class="nc bnc" id="L974" title="All 2 branches missed.">                    } else if (responseFuture.isTimeout()) {</span>
<span class="nc" id="L975">                        pullCallback.onException(new MQClientException(&quot;wait response from &quot; + addr + &quot; timeout :&quot; + responseFuture.getTimeoutMillis() + &quot;ms&quot; + &quot;. Request: &quot; + request,</span>
<span class="nc" id="L976">                            responseFuture.getCause()));</span>
                    } else {
<span class="nc" id="L978">                        pullCallback.onException(new MQClientException(&quot;unknown reason. addr: &quot; + addr + &quot;, timeoutMillis: &quot; + timeoutMillis + &quot;. Request: &quot; + request, responseFuture.getCause()));</span>
                    }
                }
<span class="nc" id="L981">            }</span>
        });
<span class="nc" id="L983">    }</span>

    private PullResult pullMessageSync(
        final String addr,
        final RemotingCommand request,
        final long timeoutMillis
    ) throws RemotingException, InterruptedException, MQBrokerException {
<span class="nc" id="L990">        RemotingCommand response = this.remotingClient.invokeSync(addr, request, timeoutMillis);</span>
<span class="nc bnc" id="L991" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc" id="L992">        return this.processPullResponse(response, addr);</span>
    }

    private PullResult processPullResponse(
        final RemotingCommand response,
        final String addr) throws MQBrokerException, RemotingCommandException {
<span class="nc" id="L998">        PullStatus pullStatus = PullStatus.NO_NEW_MSG;</span>
<span class="nc bnc" id="L999" title="All 5 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS:
<span class="nc" id="L1001">                pullStatus = PullStatus.FOUND;</span>
<span class="nc" id="L1002">                break;</span>
            case ResponseCode.PULL_NOT_FOUND:
<span class="nc" id="L1004">                pullStatus = PullStatus.NO_NEW_MSG;</span>
<span class="nc" id="L1005">                break;</span>
            case ResponseCode.PULL_RETRY_IMMEDIATELY:
<span class="nc" id="L1007">                pullStatus = PullStatus.NO_MATCHED_MSG;</span>
<span class="nc" id="L1008">                break;</span>
            case ResponseCode.PULL_OFFSET_MOVED:
<span class="nc" id="L1010">                pullStatus = PullStatus.OFFSET_ILLEGAL;</span>
<span class="nc" id="L1011">                break;</span>

            default:
<span class="nc" id="L1014">                throw new MQBrokerException(response.getCode(), response.getRemark(), addr);</span>
        }

<span class="nc" id="L1017">        PullMessageResponseHeader responseHeader =</span>
<span class="nc" id="L1018">            (PullMessageResponseHeader) response.decodeCommandCustomHeader(PullMessageResponseHeader.class);</span>

<span class="nc" id="L1020">        return new PullResultExt(pullStatus, responseHeader.getNextBeginOffset(), responseHeader.getMinOffset(),</span>
<span class="nc" id="L1021">            responseHeader.getMaxOffset(), null, responseHeader.getSuggestWhichBrokerId(), response.getBody(), responseHeader.getOffsetDelta());</span>
    }

    private PopResult processPopResponse(final String brokerName, final RemotingCommand response, String topic,
        CommandCustomHeader requestHeader) throws MQBrokerException, RemotingCommandException {
<span class="fc" id="L1026">        PopStatus popStatus = PopStatus.NO_NEW_MSG;</span>
<span class="fc" id="L1027">        List&lt;MessageExt&gt; msgFoundList = null;</span>
<span class="pc bpc" id="L1028" title="4 of 5 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS:
<span class="fc" id="L1030">                popStatus = PopStatus.FOUND;</span>
<span class="fc" id="L1031">                ByteBuffer byteBuffer = ByteBuffer.wrap(response.getBody());</span>
<span class="fc" id="L1032">                msgFoundList = MessageDecoder.decodes(byteBuffer);</span>
<span class="fc" id="L1033">                break;</span>
            case ResponseCode.POLLING_FULL:
<span class="nc" id="L1035">                popStatus = PopStatus.POLLING_FULL;</span>
<span class="nc" id="L1036">                break;</span>
            case ResponseCode.POLLING_TIMEOUT:
<span class="nc" id="L1038">                popStatus = PopStatus.POLLING_NOT_FOUND;</span>
<span class="nc" id="L1039">                break;</span>
            case ResponseCode.PULL_NOT_FOUND:
<span class="nc" id="L1041">                popStatus = PopStatus.POLLING_NOT_FOUND;</span>
<span class="nc" id="L1042">                break;</span>
            default:
<span class="nc" id="L1044">                throw new MQBrokerException(response.getCode(), response.getRemark());</span>
        }

<span class="fc" id="L1047">        PopResult popResult = new PopResult(popStatus, msgFoundList);</span>
<span class="fc" id="L1048">        PopMessageResponseHeader responseHeader = (PopMessageResponseHeader) response.decodeCommandCustomHeader(PopMessageResponseHeader.class);</span>
<span class="fc" id="L1049">        popResult.setRestNum(responseHeader.getRestNum());</span>
        // it is a pop command if pop time greater than 0, we should set the check point info to extraInfo field
<span class="pc bpc" id="L1051" title="1 of 2 branches missed.">        if (popStatus == PopStatus.FOUND) {</span>
<span class="fc" id="L1052">            Map&lt;String, Long&gt; startOffsetInfo = null;</span>
<span class="fc" id="L1053">            Map&lt;String, List&lt;Long&gt;&gt; msgOffsetInfo = null;</span>
<span class="fc" id="L1054">            Map&lt;String, Integer&gt; orderCountInfo = null;</span>
<span class="pc bpc" id="L1055" title="1 of 2 branches missed.">            if (requestHeader instanceof PopMessageRequestHeader) {</span>
<span class="fc" id="L1056">                popResult.setInvisibleTime(responseHeader.getInvisibleTime());</span>
<span class="fc" id="L1057">                popResult.setPopTime(responseHeader.getPopTime());</span>
<span class="fc" id="L1058">                startOffsetInfo = ExtraInfoUtil.parseStartOffsetInfo(responseHeader.getStartOffsetInfo());</span>
<span class="fc" id="L1059">                msgOffsetInfo = ExtraInfoUtil.parseMsgOffsetInfo(responseHeader.getMsgOffsetInfo());</span>
<span class="fc" id="L1060">                orderCountInfo = ExtraInfoUtil.parseOrderCountInfo(responseHeader.getOrderCountInfo());</span>
            }
<span class="fc" id="L1062">            Map&lt;String/*topicMark@queueId*/, List&lt;Long&gt;/*msg queueOffset*/&gt; sortMap = new HashMap&lt;String, List&lt;Long&gt;&gt;(16);</span>
<span class="fc bfc" id="L1063" title="All 2 branches covered.">            for (MessageExt messageExt : msgFoundList) {</span>
<span class="fc" id="L1064">                String key = ExtraInfoUtil.getStartOffsetInfoMapKey(messageExt.getTopic(), messageExt.getQueueId());</span>
<span class="pc bpc" id="L1065" title="1 of 2 branches missed.">                if (!sortMap.containsKey(key)) {</span>
<span class="fc" id="L1066">                    sortMap.put(key, new ArrayList&lt;Long&gt;(4));</span>
                }
<span class="fc" id="L1068">                sortMap.get(key).add(messageExt.getQueueOffset());</span>
<span class="fc" id="L1069">            }</span>
<span class="fc" id="L1070">            Map&lt;String, String&gt; map = new HashMap&lt;String, String&gt;(5);</span>
<span class="fc bfc" id="L1071" title="All 2 branches covered.">            for (MessageExt messageExt : msgFoundList) {</span>
<span class="pc bpc" id="L1072" title="1 of 2 branches missed.">                if (requestHeader instanceof PopMessageRequestHeader) {</span>
<span class="pc bpc" id="L1073" title="1 of 2 branches missed.">                    if (startOffsetInfo == null) {</span>
                        // we should set the check point info to extraInfo field , if the command is popMsg
                        // find pop ck offset
<span class="nc" id="L1076">                        String key = messageExt.getTopic() + messageExt.getQueueId();</span>
<span class="nc bnc" id="L1077" title="All 2 branches missed.">                        if (!map.containsKey(messageExt.getTopic() + messageExt.getQueueId())) {</span>
<span class="nc" id="L1078">                            map.put(key, ExtraInfoUtil.buildExtraInfo(messageExt.getQueueOffset(), responseHeader.getPopTime(), responseHeader.getInvisibleTime(), responseHeader.getReviveQid(),</span>
<span class="nc" id="L1079">                                messageExt.getTopic(), brokerName, messageExt.getQueueId()));</span>

                        }
<span class="nc" id="L1082">                        messageExt.getProperties().put(MessageConst.PROPERTY_POP_CK, map.get(key) + MessageConst.KEY_SEPARATOR + messageExt.getQueueOffset());</span>
<span class="nc" id="L1083">                    } else {</span>
<span class="fc" id="L1084">                        String key = ExtraInfoUtil.getStartOffsetInfoMapKey(messageExt.getTopic(), messageExt.getQueueId());</span>
<span class="fc" id="L1085">                        int index = sortMap.get(key).indexOf(messageExt.getQueueOffset());</span>
<span class="fc" id="L1086">                        Long msgQueueOffset = msgOffsetInfo.get(key).get(index);</span>
<span class="pc bpc" id="L1087" title="1 of 2 branches missed.">                        if (msgQueueOffset != messageExt.getQueueOffset()) {</span>
<span class="nc" id="L1088">                            log.warn(&quot;Queue offset[%d] of msg is strange, not equal to the stored in msg, %s&quot;, msgQueueOffset, messageExt);</span>
                        }

<span class="fc" id="L1091">                        messageExt.getProperties().put(MessageConst.PROPERTY_POP_CK,</span>
<span class="fc" id="L1092">                            ExtraInfoUtil.buildExtraInfo(startOffsetInfo.get(key).longValue(), responseHeader.getPopTime(), responseHeader.getInvisibleTime(),</span>
<span class="fc" id="L1093">                                responseHeader.getReviveQid(), messageExt.getTopic(), brokerName, messageExt.getQueueId(), msgQueueOffset.longValue())</span>
                        );
<span class="pc bpc" id="L1095" title="3 of 4 branches missed.">                        if (((PopMessageRequestHeader) requestHeader).isOrder() &amp;&amp; orderCountInfo != null) {</span>
<span class="nc" id="L1096">                            Integer count = orderCountInfo.get(key);</span>
<span class="nc bnc" id="L1097" title="All 4 branches missed.">                            if (count != null &amp;&amp; count &gt; 0) {</span>
<span class="nc" id="L1098">                                messageExt.setReconsumeTimes(count);</span>
                            }
                        }
                    }
<span class="pc bpc" id="L1102" title="1 of 2 branches missed.">                    if (messageExt.getProperties().get(MessageConst.PROPERTY_FIRST_POP_TIME) == null) {</span>
<span class="fc" id="L1103">                        messageExt.getProperties().put(MessageConst.PROPERTY_FIRST_POP_TIME, String.valueOf(responseHeader.getPopTime()));</span>
                    }
                }
<span class="fc" id="L1106">                messageExt.setBrokerName(brokerName);</span>
<span class="fc" id="L1107">                messageExt.setTopic(NamespaceUtil.withoutNamespace(topic, this.clientConfig.getNamespace()));</span>
<span class="fc" id="L1108">            }</span>
        }
<span class="fc" id="L1110">        return popResult;</span>
    }

    public MessageExt viewMessage(final String addr, final long phyoffset, final long timeoutMillis)
        throws RemotingException, MQBrokerException, InterruptedException {
<span class="fc" id="L1115">        ViewMessageRequestHeader requestHeader = new ViewMessageRequestHeader();</span>
<span class="fc" id="L1116">        requestHeader.setOffset(phyoffset);</span>
<span class="fc" id="L1117">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.VIEW_MESSAGE_BY_ID, requestHeader);</span>

<span class="fc" id="L1119">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="pc bpc" id="L1121" title="2 of 4 branches missed.">        assert response != null;</span>
<span class="pc bpc" id="L1122" title="1 of 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="fc" id="L1124">                ByteBuffer byteBuffer = ByteBuffer.wrap(response.getBody());</span>
<span class="fc" id="L1125">                MessageExt messageExt = MessageDecoder.clientDecode(byteBuffer, true);</span>
                //If namespace not null , reset Topic without namespace.
<span class="pc bpc" id="L1127" title="1 of 2 branches missed.">                if (StringUtils.isNotEmpty(this.clientConfig.getNamespace())) {</span>
<span class="nc" id="L1128">                    messageExt.setTopic(NamespaceUtil.withoutNamespace(messageExt.getTopic(), this.clientConfig.getNamespace()));</span>
                }
<span class="fc" id="L1130">                return messageExt;</span>
            }
            default:
                break;
        }

<span class="nc" id="L1136">        throw new MQBrokerException(response.getCode(), response.getRemark(), addr);</span>
    }

    @Deprecated
    public long searchOffset(final String addr, final String topic, final int queueId, final long timestamp,
        final long timeoutMillis)
        throws RemotingException, MQBrokerException, InterruptedException {
<span class="fc" id="L1143">        SearchOffsetRequestHeader requestHeader = new SearchOffsetRequestHeader();</span>
<span class="fc" id="L1144">        requestHeader.setTopic(topic);</span>
<span class="fc" id="L1145">        requestHeader.setQueueId(queueId);</span>
<span class="fc" id="L1146">        requestHeader.setTimestamp(timestamp);</span>
<span class="fc" id="L1147">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.SEARCH_OFFSET_BY_TIMESTAMP, requestHeader);</span>

<span class="fc" id="L1149">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="pc bpc" id="L1151" title="2 of 4 branches missed.">        assert response != null;</span>
<span class="pc bpc" id="L1152" title="1 of 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="fc" id="L1154">                SearchOffsetResponseHeader responseHeader =</span>
<span class="fc" id="L1155">                    (SearchOffsetResponseHeader) response.decodeCommandCustomHeader(SearchOffsetResponseHeader.class);</span>
<span class="fc" id="L1156">                return responseHeader.getOffset();</span>
            }
            default:
                break;
        }

<span class="nc" id="L1162">        throw new MQBrokerException(response.getCode(), response.getRemark(), addr);</span>
    }

    public long searchOffset(final String addr, final MessageQueue messageQueue, final long timestamp, final long timeoutMillis)
        throws RemotingException, MQBrokerException, InterruptedException {
<span class="nc" id="L1167">        SearchOffsetRequestHeader requestHeader = new SearchOffsetRequestHeader();</span>
<span class="nc" id="L1168">        requestHeader.setTopic(messageQueue.getTopic());</span>
<span class="nc" id="L1169">        requestHeader.setQueueId(messageQueue.getQueueId());</span>
<span class="nc" id="L1170">        requestHeader.setBname(messageQueue.getBrokerName());</span>
<span class="nc" id="L1171">        requestHeader.setTimestamp(timestamp);</span>
<span class="nc" id="L1172">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.SEARCH_OFFSET_BY_TIMESTAMP, requestHeader);</span>

<span class="nc" id="L1174">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L1176" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1177" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1179">                SearchOffsetResponseHeader responseHeader =</span>
<span class="nc" id="L1180">                    (SearchOffsetResponseHeader) response.decodeCommandCustomHeader(SearchOffsetResponseHeader.class);</span>
<span class="nc" id="L1181">                return responseHeader.getOffset();</span>
            }
            default:
                break;
        }

<span class="nc" id="L1187">        throw new MQBrokerException(response.getCode(), response.getRemark(), addr);</span>
    }

    public long getMaxOffset(final String addr, final MessageQueue messageQueue, final long timeoutMillis)
        throws RemotingException, MQBrokerException, InterruptedException {
<span class="fc" id="L1192">        GetMaxOffsetRequestHeader requestHeader = new GetMaxOffsetRequestHeader();</span>
<span class="fc" id="L1193">        requestHeader.setTopic(messageQueue.getTopic());</span>
<span class="fc" id="L1194">        requestHeader.setQueueId(messageQueue.getQueueId());</span>
<span class="fc" id="L1195">        requestHeader.setBname(messageQueue.getBrokerName());</span>
<span class="fc" id="L1196">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_MAX_OFFSET, requestHeader);</span>

<span class="fc" id="L1198">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="pc bpc" id="L1200" title="2 of 4 branches missed.">        assert response != null;</span>
<span class="pc bpc" id="L1201" title="1 of 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="fc" id="L1203">                GetMaxOffsetResponseHeader responseHeader =</span>
<span class="fc" id="L1204">                    (GetMaxOffsetResponseHeader) response.decodeCommandCustomHeader(GetMaxOffsetResponseHeader.class);</span>

<span class="fc" id="L1206">                return responseHeader.getOffset();</span>
            }
            default:
                break;
        }

<span class="nc" id="L1212">        throw new MQBrokerException(response.getCode(), response.getRemark(), addr);</span>
    }

    public List&lt;String&gt; getConsumerIdListByGroup(
        final String addr,
        final String consumerGroup,
        final long timeoutMillis) throws RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException,
        MQBrokerException, InterruptedException {
<span class="fc" id="L1220">        GetConsumerListByGroupRequestHeader requestHeader = new GetConsumerListByGroupRequestHeader();</span>
<span class="fc" id="L1221">        requestHeader.setConsumerGroup(consumerGroup);</span>
<span class="fc" id="L1222">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_CONSUMER_LIST_BY_GROUP, requestHeader);</span>

<span class="fc" id="L1224">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="pc bpc" id="L1226" title="2 of 4 branches missed.">        assert response != null;</span>
<span class="pc bpc" id="L1227" title="1 of 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="pc bpc" id="L1229" title="1 of 2 branches missed.">                if (response.getBody() != null) {</span>
<span class="fc" id="L1230">                    GetConsumerListByGroupResponseBody body =</span>
<span class="fc" id="L1231">                        GetConsumerListByGroupResponseBody.decode(response.getBody(), GetConsumerListByGroupResponseBody.class);</span>
<span class="fc" id="L1232">                    return body.getConsumerIdList();</span>
                }
            }
            default:
                break;
        }

<span class="nc" id="L1239">        throw new MQBrokerException(response.getCode(), response.getRemark(), addr);</span>
    }

    public long getMinOffset(final String addr, final MessageQueue messageQueue, final long timeoutMillis)
        throws RemotingException, MQBrokerException, InterruptedException {
<span class="fc" id="L1244">        GetMinOffsetRequestHeader requestHeader = new GetMinOffsetRequestHeader();</span>
<span class="fc" id="L1245">        requestHeader.setTopic(messageQueue.getTopic());</span>
<span class="fc" id="L1246">        requestHeader.setQueueId(messageQueue.getQueueId());</span>
<span class="fc" id="L1247">        requestHeader.setBname(messageQueue.getBrokerName());</span>
<span class="fc" id="L1248">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_MIN_OFFSET, requestHeader);</span>

<span class="fc" id="L1250">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="pc bpc" id="L1252" title="2 of 4 branches missed.">        assert response != null;</span>
<span class="pc bpc" id="L1253" title="1 of 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="fc" id="L1255">                GetMinOffsetResponseHeader responseHeader =</span>
<span class="fc" id="L1256">                    (GetMinOffsetResponseHeader) response.decodeCommandCustomHeader(GetMinOffsetResponseHeader.class);</span>

<span class="fc" id="L1258">                return responseHeader.getOffset();</span>
            }
            default:
                break;
        }

<span class="nc" id="L1264">        throw new MQBrokerException(response.getCode(), response.getRemark(), addr);</span>
    }

    public long getEarliestMsgStoretime(final String addr, final MessageQueue mq, final long timeoutMillis)
        throws RemotingException, MQBrokerException, InterruptedException {
<span class="fc" id="L1269">        GetEarliestMsgStoretimeRequestHeader requestHeader = new GetEarliestMsgStoretimeRequestHeader();</span>
<span class="fc" id="L1270">        requestHeader.setTopic(mq.getTopic());</span>
<span class="fc" id="L1271">        requestHeader.setQueueId(mq.getQueueId());</span>
<span class="fc" id="L1272">        requestHeader.setBname(mq.getBrokerName());</span>
<span class="fc" id="L1273">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_EARLIEST_MSG_STORETIME, requestHeader);</span>

<span class="fc" id="L1275">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="pc bpc" id="L1277" title="2 of 4 branches missed.">        assert response != null;</span>
<span class="pc bpc" id="L1278" title="1 of 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="fc" id="L1280">                GetEarliestMsgStoretimeResponseHeader responseHeader =</span>
<span class="fc" id="L1281">                    (GetEarliestMsgStoretimeResponseHeader) response.decodeCommandCustomHeader(GetEarliestMsgStoretimeResponseHeader.class);</span>

<span class="fc" id="L1283">                return responseHeader.getTimestamp();</span>
            }
            default:
                break;
        }

<span class="nc" id="L1289">        throw new MQBrokerException(response.getCode(), response.getRemark(), addr);</span>
    }

    public long queryConsumerOffset(
        final String addr,
        final QueryConsumerOffsetRequestHeader requestHeader,
        final long timeoutMillis
    ) throws RemotingException, MQBrokerException, InterruptedException {
<span class="fc" id="L1297">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.QUERY_CONSUMER_OFFSET, requestHeader);</span>

<span class="fc" id="L1299">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="pc bpc" id="L1301" title="2 of 4 branches missed.">        assert response != null;</span>
<span class="pc bpc" id="L1302" title="2 of 3 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="fc" id="L1304">                QueryConsumerOffsetResponseHeader responseHeader =</span>
<span class="fc" id="L1305">                    (QueryConsumerOffsetResponseHeader) response.decodeCommandCustomHeader(QueryConsumerOffsetResponseHeader.class);</span>
<span class="fc" id="L1306">                return responseHeader.getOffset();</span>
            }
            case ResponseCode.QUERY_NOT_FOUND: {
<span class="nc" id="L1309">                throw new OffsetNotFoundException(response.getCode(), response.getRemark(), addr);</span>
            }
            default:
                break;
        }

<span class="nc" id="L1315">        throw new MQBrokerException(response.getCode(), response.getRemark(), addr);</span>
    }

    public void updateConsumerOffset(
        final String addr,
        final UpdateConsumerOffsetRequestHeader requestHeader,
        final long timeoutMillis
    ) throws RemotingException, MQBrokerException, InterruptedException {
<span class="fc" id="L1323">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.UPDATE_CONSUMER_OFFSET, requestHeader);</span>

<span class="fc" id="L1325">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="pc bpc" id="L1327" title="2 of 4 branches missed.">        assert response != null;</span>
<span class="pc bpc" id="L1328" title="1 of 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="fc" id="L1330">                return;</span>
            }
            default:
                break;
        }

<span class="nc" id="L1336">        throw new MQBrokerException(response.getCode(), response.getRemark(), addr);</span>
    }

    public void updateConsumerOffsetOneway(
        final String addr,
        final UpdateConsumerOffsetRequestHeader requestHeader,
        final long timeoutMillis
    ) throws RemotingConnectException, RemotingTooMuchRequestException, RemotingTimeoutException, RemotingSendRequestException,
        InterruptedException {
<span class="nc" id="L1345">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.UPDATE_CONSUMER_OFFSET, requestHeader);</span>

<span class="nc" id="L1347">        this.remotingClient.invokeOneway(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr), request, timeoutMillis);</span>
<span class="nc" id="L1348">    }</span>

    public int sendHeartbeat(
        final String addr,
        final HeartbeatData heartbeatData,
        final long timeoutMillis
    ) throws RemotingException, MQBrokerException, InterruptedException {
<span class="nc" id="L1355">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.HEART_BEAT, null);</span>
<span class="nc" id="L1356">        request.setLanguage(clientConfig.getLanguage());</span>
<span class="nc" id="L1357">        request.setBody(heartbeatData.encode());</span>
<span class="nc" id="L1358">        RemotingCommand response = this.remotingClient.invokeSync(addr, request, timeoutMillis);</span>
<span class="nc bnc" id="L1359" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1360" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1362">                return response.getVersion();</span>
            }
            default:
                break;
        }

<span class="nc" id="L1368">        throw new MQBrokerException(response.getCode(), response.getRemark(), addr);</span>
    }

    public void unregisterClient(
        final String addr,
        final String clientID,
        final String producerGroup,
        final String consumerGroup,
        final long timeoutMillis
    ) throws RemotingException, MQBrokerException, InterruptedException {
<span class="nc" id="L1378">        final UnregisterClientRequestHeader requestHeader = new UnregisterClientRequestHeader();</span>
<span class="nc" id="L1379">        requestHeader.setClientID(clientID);</span>
<span class="nc" id="L1380">        requestHeader.setProducerGroup(producerGroup);</span>
<span class="nc" id="L1381">        requestHeader.setConsumerGroup(consumerGroup);</span>
<span class="nc" id="L1382">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.UNREGISTER_CLIENT, requestHeader);</span>

<span class="nc" id="L1384">        RemotingCommand response = this.remotingClient.invokeSync(addr, request, timeoutMillis);</span>
<span class="nc bnc" id="L1385" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1386" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1388">                return;</span>
            }
            default:
                break;
        }

<span class="nc" id="L1394">        throw new MQBrokerException(response.getCode(), response.getRemark(), addr);</span>
    }

    public void endTransactionOneway(
        final String addr,
        final EndTransactionRequestHeader requestHeader,
        final String remark,
        final long timeoutMillis
    ) throws RemotingException, InterruptedException {
<span class="nc" id="L1403">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.END_TRANSACTION, requestHeader);</span>

<span class="nc" id="L1405">        request.setRemark(remark);</span>
<span class="nc" id="L1406">        this.remotingClient.invokeOneway(addr, request, timeoutMillis);</span>
<span class="nc" id="L1407">    }</span>

    public void queryMessage(
        final String addr,
        final QueryMessageRequestHeader requestHeader,
        final long timeoutMillis,
        final InvokeCallback invokeCallback,
        final Boolean isUnqiueKey
    ) throws RemotingException, MQBrokerException, InterruptedException {
<span class="nc" id="L1416">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.QUERY_MESSAGE, requestHeader);</span>
<span class="nc" id="L1417">        request.addExtField(MixAll.UNIQUE_MSG_QUERY_FLAG, isUnqiueKey.toString());</span>
<span class="nc" id="L1418">        this.remotingClient.invokeAsync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr), request, timeoutMillis,</span>
            invokeCallback);
<span class="nc" id="L1420">    }</span>

    public boolean registerClient(final String addr, final HeartbeatData heartbeat, final long timeoutMillis)
        throws RemotingException, InterruptedException {
<span class="nc" id="L1424">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.HEART_BEAT, null);</span>

<span class="nc" id="L1426">        request.setBody(heartbeat.encode());</span>
<span class="nc" id="L1427">        RemotingCommand response = this.remotingClient.invokeSync(addr, request, timeoutMillis);</span>
<span class="nc bnc" id="L1428" title="All 2 branches missed.">        return response.getCode() == ResponseCode.SUCCESS;</span>
    }

    public void consumerSendMessageBack(
        final String addr,
        final MessageExt msg,
        final String consumerGroup,
        final int delayLevel,
        final long timeoutMillis,
        final int maxConsumeRetryTimes
    ) throws RemotingException, MQBrokerException, InterruptedException {
<span class="nc" id="L1439">        ConsumerSendMsgBackRequestHeader requestHeader = new ConsumerSendMsgBackRequestHeader();</span>
<span class="nc" id="L1440">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.CONSUMER_SEND_MSG_BACK, requestHeader);</span>

<span class="nc" id="L1442">        requestHeader.setGroup(consumerGroup);</span>
<span class="nc" id="L1443">        requestHeader.setOriginTopic(msg.getTopic());</span>
<span class="nc" id="L1444">        requestHeader.setOffset(msg.getCommitLogOffset());</span>
<span class="nc" id="L1445">        requestHeader.setDelayLevel(delayLevel);</span>
<span class="nc" id="L1446">        requestHeader.setOriginMsgId(msg.getMsgId());</span>
<span class="nc" id="L1447">        requestHeader.setMaxReconsumeTimes(maxConsumeRetryTimes);</span>

<span class="nc" id="L1449">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L1451" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1452" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1454">                return;</span>
            }
            default:
                break;
        }

<span class="nc" id="L1460">        throw new MQBrokerException(response.getCode(), response.getRemark(), addr);</span>
    }

    public Set&lt;MessageQueue&gt; lockBatchMQ(
        final String addr,
        final LockBatchRequestBody requestBody,
        final long timeoutMillis) throws RemotingException, MQBrokerException, InterruptedException {
<span class="nc" id="L1467">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.LOCK_BATCH_MQ, null);</span>

<span class="nc" id="L1469">        request.setBody(requestBody.encode());</span>
<span class="nc" id="L1470">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L1472" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1474">                LockBatchResponseBody responseBody = LockBatchResponseBody.decode(response.getBody(), LockBatchResponseBody.class);</span>
<span class="nc" id="L1475">                Set&lt;MessageQueue&gt; messageQueues = responseBody.getLockOKMQSet();</span>
<span class="nc" id="L1476">                return messageQueues;</span>
            }
            default:
                break;
        }

<span class="nc" id="L1482">        throw new MQBrokerException(response.getCode(), response.getRemark(), addr);</span>
    }

    public void unlockBatchMQ(
        final String addr,
        final UnlockBatchRequestBody requestBody,
        final long timeoutMillis,
        final boolean oneway
    ) throws RemotingException, MQBrokerException, InterruptedException {
<span class="nc" id="L1491">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.UNLOCK_BATCH_MQ, null);</span>

<span class="nc" id="L1493">        request.setBody(requestBody.encode());</span>

<span class="nc bnc" id="L1495" title="All 2 branches missed.">        if (oneway) {</span>
<span class="nc" id="L1496">            this.remotingClient.invokeOneway(addr, request, timeoutMillis);</span>
        } else {
<span class="nc" id="L1498">            RemotingCommand response = this.remotingClient</span>
<span class="nc" id="L1499">                .invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr), request, timeoutMillis);</span>
<span class="nc bnc" id="L1500" title="All 2 branches missed.">            switch (response.getCode()) {</span>
                case ResponseCode.SUCCESS: {
<span class="nc" id="L1502">                    return;</span>
                }
                default:
                    break;
            }

<span class="nc" id="L1508">            throw new MQBrokerException(response.getCode(), response.getRemark(), addr);</span>
        }
<span class="nc" id="L1510">    }</span>

    public TopicStatsTable getTopicStatsInfo(final String addr, final String topic,
        final long timeoutMillis) throws InterruptedException,
        RemotingTimeoutException, RemotingSendRequestException, RemotingConnectException, MQBrokerException {
<span class="nc" id="L1515">        GetTopicStatsInfoRequestHeader requestHeader = new GetTopicStatsInfoRequestHeader();</span>
<span class="nc" id="L1516">        requestHeader.setTopic(topic);</span>

<span class="nc" id="L1518">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_TOPIC_STATS_INFO, requestHeader);</span>

<span class="nc" id="L1520">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L1522" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1524">                TopicStatsTable topicStatsTable = TopicStatsTable.decode(response.getBody(), TopicStatsTable.class);</span>
<span class="nc" id="L1525">                return topicStatsTable;</span>
            }
            default:
                break;
        }

<span class="nc" id="L1531">        throw new MQBrokerException(response.getCode(), response.getRemark(), addr);</span>
    }

    public ConsumeStats getConsumeStats(final String addr, final String consumerGroup, final long timeoutMillis)
        throws InterruptedException, RemotingTimeoutException, RemotingSendRequestException, RemotingConnectException,
        MQBrokerException {
<span class="nc" id="L1537">        return getConsumeStats(addr, consumerGroup, null, timeoutMillis);</span>
    }

    public ConsumeStats getConsumeStats(final String addr, final String consumerGroup, final String topic,
        final long timeoutMillis)
        throws InterruptedException, RemotingTimeoutException, RemotingSendRequestException, RemotingConnectException,
        MQBrokerException {
<span class="nc" id="L1544">        GetConsumeStatsRequestHeader requestHeader = new GetConsumeStatsRequestHeader();</span>
<span class="nc" id="L1545">        requestHeader.setConsumerGroup(consumerGroup);</span>
<span class="nc" id="L1546">        requestHeader.setTopic(topic);</span>

<span class="nc" id="L1548">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_CONSUME_STATS, requestHeader);</span>

<span class="nc" id="L1550">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L1552" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1554">                ConsumeStats consumeStats = ConsumeStats.decode(response.getBody(), ConsumeStats.class);</span>
<span class="nc" id="L1555">                return consumeStats;</span>
            }
            default:
                break;
        }

<span class="nc" id="L1561">        throw new MQBrokerException(response.getCode(), response.getRemark(), addr);</span>
    }

    public ProducerConnection getProducerConnectionList(final String addr, final String producerGroup,
        final long timeoutMillis)
        throws RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException, InterruptedException,
        MQBrokerException {
<span class="nc" id="L1568">        GetProducerConnectionListRequestHeader requestHeader = new GetProducerConnectionListRequestHeader();</span>
<span class="nc" id="L1569">        requestHeader.setProducerGroup(producerGroup);</span>

<span class="nc" id="L1571">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_PRODUCER_CONNECTION_LIST, requestHeader);</span>

<span class="nc" id="L1573">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L1575" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1577">                return ProducerConnection.decode(response.getBody(), ProducerConnection.class);</span>
            }
            default:
                break;
        }

<span class="nc" id="L1583">        throw new MQBrokerException(response.getCode(), response.getRemark(), addr);</span>
    }

    public ProducerTableInfo getAllProducerInfo(final String addr, final long timeoutMillis)
            throws RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException, InterruptedException,
            MQBrokerException {
<span class="nc" id="L1589">        GetAllProducerInfoRequestHeader requestHeader = new GetAllProducerInfoRequestHeader();</span>

<span class="nc" id="L1591">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_ALL_PRODUCER_INFO, requestHeader);</span>

<span class="nc" id="L1593">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
                request, timeoutMillis);
<span class="nc bnc" id="L1595" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1597">                return ProducerTableInfo.decode(response.getBody(), ProducerTableInfo.class);</span>
            }
            default:
                break;
        }

<span class="nc" id="L1603">        throw new MQBrokerException(response.getCode(), response.getRemark(), addr);</span>
    }

    public ConsumerConnection getConsumerConnectionList(final String addr, final String consumerGroup,
        final long timeoutMillis)
        throws RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException, InterruptedException,
        MQBrokerException {
<span class="nc" id="L1610">        GetConsumerConnectionListRequestHeader requestHeader = new GetConsumerConnectionListRequestHeader();</span>
<span class="nc" id="L1611">        requestHeader.setConsumerGroup(consumerGroup);</span>

<span class="nc" id="L1613">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_CONSUMER_CONNECTION_LIST, requestHeader);</span>

<span class="nc" id="L1615">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L1617" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1619">                return ConsumerConnection.decode(response.getBody(), ConsumerConnection.class);</span>
            }
            default:
                break;
        }

<span class="nc" id="L1625">        throw new MQBrokerException(response.getCode(), response.getRemark(), addr);</span>
    }

    public KVTable getBrokerRuntimeInfo(final String addr, final long timeoutMillis) throws RemotingConnectException,
        RemotingSendRequestException, RemotingTimeoutException, InterruptedException, MQBrokerException {

<span class="nc" id="L1631">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_BROKER_RUNTIME_INFO, null);</span>

<span class="nc" id="L1633">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L1635" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1637">                return KVTable.decode(response.getBody(), KVTable.class);</span>
            }
            default:
                break;
        }

<span class="nc" id="L1643">        throw new MQBrokerException(response.getCode(), response.getRemark(), addr);</span>
    }

    public void addBroker(final String addr, final String brokerConfigPath, final long timeoutMillis)
        throws InterruptedException, RemotingTimeoutException, RemotingSendRequestException, RemotingConnectException, MQBrokerException {
<span class="nc" id="L1648">        AddBrokerRequestHeader requestHeader = new AddBrokerRequestHeader();</span>
<span class="nc" id="L1649">        requestHeader.setConfigPath(brokerConfigPath);</span>

<span class="nc" id="L1651">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.ADD_BROKER, requestHeader);</span>
<span class="nc" id="L1652">        RemotingCommand response = this.remotingClient.invokeSync(addr, request, timeoutMillis);</span>
<span class="nc bnc" id="L1653" title="All 4 branches missed.">        assert response != null;</span>

<span class="nc bnc" id="L1655" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS:
<span class="nc" id="L1657">                return;</span>
            default:
                break;
        }

<span class="nc" id="L1662">        throw new MQBrokerException(response.getCode(), response.getRemark());</span>
    }

    public void removeBroker(final String addr, String clusterName, String brokerName, long brokerId,
        final long timeoutMillis)
        throws InterruptedException, RemotingTimeoutException, RemotingSendRequestException, RemotingConnectException, MQBrokerException {
<span class="nc" id="L1668">        RemoveBrokerRequestHeader requestHeader = new RemoveBrokerRequestHeader();</span>
<span class="nc" id="L1669">        requestHeader.setBrokerClusterName(clusterName);</span>
<span class="nc" id="L1670">        requestHeader.setBrokerName(brokerName);</span>
<span class="nc" id="L1671">        requestHeader.setBrokerId(brokerId);</span>

<span class="nc" id="L1673">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.REMOVE_BROKER, requestHeader);</span>
<span class="nc" id="L1674">        RemotingCommand response = this.remotingClient.invokeSync(addr, request, timeoutMillis);</span>
<span class="nc bnc" id="L1675" title="All 4 branches missed.">        assert response != null;</span>

<span class="nc bnc" id="L1677" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS:
<span class="nc" id="L1679">                return;</span>
            default:
                break;
        }

<span class="nc" id="L1684">        throw new MQBrokerException(response.getCode(), response.getRemark());</span>
    }

    public void updateBrokerConfig(final String addr, final Properties properties, final long timeoutMillis)
        throws RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException, InterruptedException,
        MQBrokerException, UnsupportedEncodingException {

<span class="nc" id="L1691">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.UPDATE_BROKER_CONFIG, null);</span>

<span class="nc" id="L1693">        String str = MixAll.properties2String(properties);</span>
<span class="nc bnc" id="L1694" title="All 4 branches missed.">        if (str != null &amp;&amp; str.length() &gt; 0) {</span>
<span class="nc" id="L1695">            request.setBody(str.getBytes(MixAll.DEFAULT_CHARSET));</span>
<span class="nc" id="L1696">            RemotingCommand response = this.remotingClient</span>
<span class="nc" id="L1697">                .invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr), request, timeoutMillis);</span>
<span class="nc bnc" id="L1698" title="All 2 branches missed.">            switch (response.getCode()) {</span>
                case ResponseCode.SUCCESS: {
<span class="nc" id="L1700">                    return;</span>
                }
                default:
                    break;
            }

<span class="nc" id="L1706">            throw new MQBrokerException(response.getCode(), response.getRemark(), addr);</span>
        }
<span class="nc" id="L1708">    }</span>

    public Properties getBrokerConfig(final String addr, final long timeoutMillis)
        throws RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException, InterruptedException,
        MQBrokerException, UnsupportedEncodingException {
<span class="nc" id="L1713">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_BROKER_CONFIG, null);</span>

<span class="nc" id="L1715">        RemotingCommand response = this.remotingClient.invokeSync(addr, request, timeoutMillis);</span>
<span class="nc bnc" id="L1716" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1717" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1719">                return MixAll.string2Properties(new String(response.getBody(), MixAll.DEFAULT_CHARSET));</span>
            }
            default:
                break;
        }

<span class="nc" id="L1725">        throw new MQBrokerException(response.getCode(), response.getRemark(), addr);</span>
    }

    public ClusterInfo getBrokerClusterInfo(
        final long timeoutMillis) throws InterruptedException, RemotingTimeoutException,
        RemotingSendRequestException, RemotingConnectException, MQBrokerException {
<span class="nc" id="L1731">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_BROKER_CLUSTER_INFO, null);</span>

<span class="nc" id="L1733">        RemotingCommand response = this.remotingClient.invokeSync(null, request, timeoutMillis);</span>
<span class="nc bnc" id="L1734" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1735" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1737">                return ClusterInfo.decode(response.getBody(), ClusterInfo.class);</span>
            }
            default:
                break;
        }

<span class="nc" id="L1743">        throw new MQBrokerException(response.getCode(), response.getRemark());</span>
    }

    public TopicRouteData getDefaultTopicRouteInfoFromNameServer(final String topic, final long timeoutMillis)
        throws RemotingException, MQClientException, InterruptedException {

<span class="nc" id="L1749">        return getTopicRouteInfoFromNameServer(topic, timeoutMillis, false);</span>
    }

    public TopicRouteData getTopicRouteInfoFromNameServer(final String topic, final long timeoutMillis)
        throws RemotingException, MQClientException, InterruptedException {
<span class="nc" id="L1754">        return getTopicRouteInfoFromNameServer(topic, timeoutMillis, true);</span>
    }

    public TopicRouteData getTopicRouteInfoFromNameServer(final String topic, final long timeoutMillis,
        boolean allowTopicNotExist) throws MQClientException, InterruptedException, RemotingTimeoutException, RemotingSendRequestException, RemotingConnectException {
<span class="fc" id="L1759">        GetRouteInfoRequestHeader requestHeader = new GetRouteInfoRequestHeader();</span>
<span class="fc" id="L1760">        requestHeader.setTopic(topic);</span>
<span class="fc" id="L1761">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_ROUTEINFO_BY_TOPIC, requestHeader);</span>

<span class="nc" id="L1763">        RemotingCommand response = this.remotingClient.invokeSync(null, request, timeoutMillis);</span>
<span class="nc bnc" id="L1764" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1765" title="All 3 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.TOPIC_NOT_EXIST: {
<span class="nc bnc" id="L1767" title="All 2 branches missed.">                if (allowTopicNotExist) {</span>
<span class="nc" id="L1768">                    log.warn(&quot;get Topic [{}] RouteInfoFromNameServer is not exist value&quot;, topic);</span>
                }

                break;
            }
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1774">                byte[] body = response.getBody();</span>
<span class="nc bnc" id="L1775" title="All 2 branches missed.">                if (body != null) {</span>
<span class="nc" id="L1776">                    return TopicRouteData.decode(body, TopicRouteData.class);</span>
                }
            }
            default:
                break;
        }

<span class="nc" id="L1783">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public TopicList getTopicListFromNameServer(final long timeoutMillis)
        throws RemotingException, MQClientException, InterruptedException {
<span class="nc" id="L1788">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_ALL_TOPIC_LIST_FROM_NAMESERVER, null);</span>
<span class="nc" id="L1789">        RemotingCommand response = this.remotingClient.invokeSync(null, request, timeoutMillis);</span>
<span class="nc bnc" id="L1790" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1791" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1793">                byte[] body = response.getBody();</span>
<span class="nc bnc" id="L1794" title="All 2 branches missed.">                if (body != null) {</span>
<span class="nc" id="L1795">                    return TopicList.decode(body, TopicList.class);</span>
                }
            }
            default:
                break;
        }

<span class="nc" id="L1802">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public int wipeWritePermOfBroker(final String namesrvAddr, String brokerName,
        final long timeoutMillis) throws RemotingCommandException,
        RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException, InterruptedException, MQClientException {
<span class="nc" id="L1808">        WipeWritePermOfBrokerRequestHeader requestHeader = new WipeWritePermOfBrokerRequestHeader();</span>
<span class="nc" id="L1809">        requestHeader.setBrokerName(brokerName);</span>

<span class="nc" id="L1811">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.WIPE_WRITE_PERM_OF_BROKER, requestHeader);</span>
<span class="nc" id="L1812">        RemotingCommand response = this.remotingClient.invokeSync(namesrvAddr, request, timeoutMillis);</span>
<span class="nc bnc" id="L1813" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1814" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1816">                WipeWritePermOfBrokerResponseHeader responseHeader =</span>
<span class="nc" id="L1817">                    (WipeWritePermOfBrokerResponseHeader) response.decodeCommandCustomHeader(WipeWritePermOfBrokerResponseHeader.class);</span>
<span class="nc" id="L1818">                return responseHeader.getWipeTopicCount();</span>
            }
            default:
                break;
        }

<span class="nc" id="L1824">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public int addWritePermOfBroker(final String nameSrvAddr, String brokerName, final long timeoutMillis)
        throws RemotingCommandException,
        RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException, InterruptedException, MQClientException {
<span class="fc" id="L1830">        AddWritePermOfBrokerRequestHeader requestHeader = new AddWritePermOfBrokerRequestHeader();</span>
<span class="fc" id="L1831">        requestHeader.setBrokerName(brokerName);</span>

<span class="fc" id="L1833">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.ADD_WRITE_PERM_OF_BROKER, requestHeader);</span>

<span class="fc" id="L1835">        RemotingCommand response = this.remotingClient.invokeSync(nameSrvAddr, request, timeoutMillis);</span>
<span class="pc bpc" id="L1836" title="2 of 4 branches missed.">        assert response != null;</span>
<span class="pc bpc" id="L1837" title="1 of 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="fc" id="L1839">                AddWritePermOfBrokerResponseHeader responseHeader =</span>
<span class="fc" id="L1840">                    (AddWritePermOfBrokerResponseHeader) response.decodeCommandCustomHeader(AddWritePermOfBrokerResponseHeader.class);</span>
<span class="fc" id="L1841">                return responseHeader.getAddTopicCount();</span>
            }
            default:
                break;
        }
<span class="nc" id="L1846">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public void deleteTopicInBroker(final String addr, final String topic, final long timeoutMillis)
        throws RemotingException, InterruptedException, MQClientException {
<span class="nc" id="L1851">        DeleteTopicRequestHeader requestHeader = new DeleteTopicRequestHeader();</span>
<span class="nc" id="L1852">        requestHeader.setTopic(topic);</span>
<span class="nc" id="L1853">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.DELETE_TOPIC_IN_BROKER, requestHeader);</span>
<span class="nc" id="L1854">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L1856" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1857" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1859">                return;</span>
            }
            default:
                break;
        }

<span class="nc" id="L1865">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public void deleteTopicInNameServer(final String addr, final String topic, final long timeoutMillis)
        throws RemotingException, InterruptedException, MQClientException {
<span class="nc" id="L1870">        DeleteTopicFromNamesrvRequestHeader requestHeader = new DeleteTopicFromNamesrvRequestHeader();</span>
<span class="nc" id="L1871">        requestHeader.setTopic(topic);</span>
<span class="nc" id="L1872">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.DELETE_TOPIC_IN_NAMESRV, requestHeader);</span>
<span class="nc" id="L1873">        RemotingCommand response = this.remotingClient.invokeSync(addr, request, timeoutMillis);</span>
<span class="nc bnc" id="L1874" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1875" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1877">                return;</span>
            }
            default:
                break;
        }

<span class="nc" id="L1883">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public void deleteTopicInNameServer(final String addr, final String clusterName, final String topic,
        final long timeoutMillis)
        throws RemotingException, MQBrokerException, InterruptedException, MQClientException {
<span class="nc" id="L1889">        DeleteTopicFromNamesrvRequestHeader requestHeader = new DeleteTopicFromNamesrvRequestHeader();</span>
<span class="nc" id="L1890">        requestHeader.setTopic(topic);</span>
<span class="nc" id="L1891">        requestHeader.setClusterName(clusterName);</span>
<span class="nc" id="L1892">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.DELETE_TOPIC_IN_NAMESRV, requestHeader);</span>
<span class="nc" id="L1893">        RemotingCommand response = this.remotingClient.invokeSync(addr, request, timeoutMillis);</span>
<span class="nc bnc" id="L1894" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1895" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1897">                return;</span>
            }
            default:
                break;
        }

<span class="nc" id="L1903">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public void deleteSubscriptionGroup(final String addr, final String groupName, final boolean removeOffset,
        final long timeoutMillis)
        throws RemotingException, InterruptedException, MQClientException {
<span class="nc" id="L1909">        DeleteSubscriptionGroupRequestHeader requestHeader = new DeleteSubscriptionGroupRequestHeader();</span>
<span class="nc" id="L1910">        requestHeader.setGroupName(groupName);</span>
<span class="nc" id="L1911">        requestHeader.setCleanOffset(removeOffset);</span>
<span class="nc" id="L1912">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.DELETE_SUBSCRIPTIONGROUP, requestHeader);</span>

<span class="nc" id="L1914">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L1916" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1917" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1919">                return;</span>
            }
            default:
                break;
        }

<span class="nc" id="L1925">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public String getKVConfigValue(final String namespace, final String key, final long timeoutMillis)
        throws RemotingException, MQClientException, InterruptedException {
<span class="nc" id="L1930">        GetKVConfigRequestHeader requestHeader = new GetKVConfigRequestHeader();</span>
<span class="nc" id="L1931">        requestHeader.setNamespace(namespace);</span>
<span class="nc" id="L1932">        requestHeader.setKey(key);</span>

<span class="nc" id="L1934">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_KV_CONFIG, requestHeader);</span>
<span class="nc" id="L1935">        RemotingCommand response = this.remotingClient.invokeSync(null, request, timeoutMillis);</span>
<span class="nc bnc" id="L1936" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L1937" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L1939">                GetKVConfigResponseHeader responseHeader =</span>
<span class="nc" id="L1940">                    (GetKVConfigResponseHeader) response.decodeCommandCustomHeader(GetKVConfigResponseHeader.class);</span>
<span class="nc" id="L1941">                return responseHeader.getValue();</span>
            }
            default:
                break;
        }

<span class="nc" id="L1947">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public void putKVConfigValue(final String namespace, final String key, final String value, final long timeoutMillis)
        throws RemotingException, MQClientException, InterruptedException {
<span class="nc" id="L1952">        PutKVConfigRequestHeader requestHeader = new PutKVConfigRequestHeader();</span>
<span class="nc" id="L1953">        requestHeader.setNamespace(namespace);</span>
<span class="nc" id="L1954">        requestHeader.setKey(key);</span>
<span class="nc" id="L1955">        requestHeader.setValue(value);</span>

<span class="nc" id="L1957">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.PUT_KV_CONFIG, requestHeader);</span>

<span class="nc" id="L1959">        List&lt;String&gt; nameServerAddressList = this.remotingClient.getNameServerAddressList();</span>
<span class="nc bnc" id="L1960" title="All 2 branches missed.">        if (nameServerAddressList != null) {</span>
<span class="nc" id="L1961">            RemotingCommand errResponse = null;</span>
<span class="nc bnc" id="L1962" title="All 2 branches missed.">            for (String namesrvAddr : nameServerAddressList) {</span>
<span class="nc" id="L1963">                RemotingCommand response = this.remotingClient.invokeSync(namesrvAddr, request, timeoutMillis);</span>
<span class="nc bnc" id="L1964" title="All 4 branches missed.">                assert response != null;</span>
<span class="nc bnc" id="L1965" title="All 2 branches missed.">                switch (response.getCode()) {</span>
                    case ResponseCode.SUCCESS: {
<span class="nc" id="L1967">                        break;</span>
                    }
                    default:
<span class="nc" id="L1970">                        errResponse = response;</span>
                }
<span class="nc" id="L1972">            }</span>

<span class="nc bnc" id="L1974" title="All 2 branches missed.">            if (errResponse != null) {</span>
<span class="nc" id="L1975">                throw new MQClientException(errResponse.getCode(), errResponse.getRemark());</span>
            }
        }
<span class="nc" id="L1978">    }</span>

    public void deleteKVConfigValue(final String namespace, final String key, final long timeoutMillis)
        throws RemotingException, MQClientException, InterruptedException {
<span class="nc" id="L1982">        DeleteKVConfigRequestHeader requestHeader = new DeleteKVConfigRequestHeader();</span>
<span class="nc" id="L1983">        requestHeader.setNamespace(namespace);</span>
<span class="nc" id="L1984">        requestHeader.setKey(key);</span>

<span class="nc" id="L1986">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.DELETE_KV_CONFIG, requestHeader);</span>

<span class="nc" id="L1988">        List&lt;String&gt; nameServerAddressList = this.remotingClient.getNameServerAddressList();</span>
<span class="nc bnc" id="L1989" title="All 2 branches missed.">        if (nameServerAddressList != null) {</span>
<span class="nc" id="L1990">            RemotingCommand errResponse = null;</span>
<span class="nc bnc" id="L1991" title="All 2 branches missed.">            for (String namesrvAddr : nameServerAddressList) {</span>
<span class="nc" id="L1992">                RemotingCommand response = this.remotingClient.invokeSync(namesrvAddr, request, timeoutMillis);</span>
<span class="nc bnc" id="L1993" title="All 4 branches missed.">                assert response != null;</span>
<span class="nc bnc" id="L1994" title="All 2 branches missed.">                switch (response.getCode()) {</span>
                    case ResponseCode.SUCCESS: {
<span class="nc" id="L1996">                        break;</span>
                    }
                    default:
<span class="nc" id="L1999">                        errResponse = response;</span>
                }
<span class="nc" id="L2001">            }</span>
<span class="nc bnc" id="L2002" title="All 2 branches missed.">            if (errResponse != null) {</span>
<span class="nc" id="L2003">                throw new MQClientException(errResponse.getCode(), errResponse.getRemark());</span>
            }
        }
<span class="nc" id="L2006">    }</span>

    public KVTable getKVListByNamespace(final String namespace, final long timeoutMillis)
        throws RemotingException, MQClientException, InterruptedException {
<span class="nc" id="L2010">        GetKVListByNamespaceRequestHeader requestHeader = new GetKVListByNamespaceRequestHeader();</span>
<span class="nc" id="L2011">        requestHeader.setNamespace(namespace);</span>

<span class="nc" id="L2013">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_KVLIST_BY_NAMESPACE, requestHeader);</span>
<span class="nc" id="L2014">        RemotingCommand response = this.remotingClient.invokeSync(null, request, timeoutMillis);</span>
<span class="nc bnc" id="L2015" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L2016" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L2018">                return KVTable.decode(response.getBody(), KVTable.class);</span>
            }
            default:
                break;
        }

<span class="nc" id="L2024">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public Map&lt;MessageQueue, Long&gt; invokeBrokerToResetOffset(final String addr, final String topic, final String group,
        final long timestamp, final boolean isForce, final long timeoutMillis)
        throws RemotingException, MQClientException, InterruptedException {
<span class="nc" id="L2030">        return invokeBrokerToResetOffset(addr, topic, group, timestamp, isForce, timeoutMillis, false);</span>
    }

    public Map&lt;MessageQueue, Long&gt; invokeBrokerToResetOffset(final String addr, final String topic, final String group,
        final long timestamp, final boolean isForce, final long timeoutMillis, boolean isC)
        throws RemotingException, MQClientException, InterruptedException {
<span class="nc" id="L2036">        ResetOffsetRequestHeader requestHeader = new ResetOffsetRequestHeader();</span>
<span class="nc" id="L2037">        requestHeader.setTopic(topic);</span>
<span class="nc" id="L2038">        requestHeader.setGroup(group);</span>
<span class="nc" id="L2039">        requestHeader.setTimestamp(timestamp);</span>
<span class="nc" id="L2040">        requestHeader.setForce(isForce);</span>

<span class="nc" id="L2042">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.INVOKE_BROKER_TO_RESET_OFFSET, requestHeader);</span>
<span class="nc bnc" id="L2043" title="All 2 branches missed.">        if (isC) {</span>
<span class="nc" id="L2044">            request.setLanguage(LanguageCode.CPP);</span>
        }
<span class="nc" id="L2046">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L2048" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L2049" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc bnc" id="L2051" title="All 2 branches missed.">                if (response.getBody() != null) {</span>
<span class="nc" id="L2052">                    ResetOffsetBody body = ResetOffsetBody.decode(response.getBody(), ResetOffsetBody.class);</span>
<span class="nc" id="L2053">                    return body.getOffsetTable();</span>
                }
            }
            default:
                break;
        }

<span class="nc" id="L2060">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public Map&lt;String, Map&lt;MessageQueue, Long&gt;&gt; invokeBrokerToGetConsumerStatus(final String addr, final String topic,
        final String group,
        final String clientAddr,
        final long timeoutMillis) throws RemotingException, MQClientException, InterruptedException {
<span class="nc" id="L2067">        GetConsumerStatusRequestHeader requestHeader = new GetConsumerStatusRequestHeader();</span>
<span class="nc" id="L2068">        requestHeader.setTopic(topic);</span>
<span class="nc" id="L2069">        requestHeader.setGroup(group);</span>
<span class="nc" id="L2070">        requestHeader.setClientAddr(clientAddr);</span>

<span class="nc" id="L2072">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.INVOKE_BROKER_TO_GET_CONSUMER_STATUS, requestHeader);</span>
<span class="nc" id="L2073">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L2075" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L2076" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc bnc" id="L2078" title="All 2 branches missed.">                if (response.getBody() != null) {</span>
<span class="nc" id="L2079">                    GetConsumerStatusBody body = GetConsumerStatusBody.decode(response.getBody(), GetConsumerStatusBody.class);</span>
<span class="nc" id="L2080">                    return body.getConsumerTable();</span>
                }
            }
            default:
                break;
        }

<span class="nc" id="L2087">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public GroupList queryTopicConsumeByWho(final String addr, final String topic, final long timeoutMillis)
        throws RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException, InterruptedException,
        MQBrokerException {
<span class="nc" id="L2093">        QueryTopicConsumeByWhoRequestHeader requestHeader = new QueryTopicConsumeByWhoRequestHeader();</span>
<span class="nc" id="L2094">        requestHeader.setTopic(topic);</span>

<span class="nc" id="L2096">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.QUERY_TOPIC_CONSUME_BY_WHO, requestHeader);</span>
<span class="nc" id="L2097">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L2099" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L2101">                GroupList groupList = GroupList.decode(response.getBody(), GroupList.class);</span>
<span class="nc" id="L2102">                return groupList;</span>
            }
            default:
                break;
        }

<span class="nc" id="L2108">        throw new MQBrokerException(response.getCode(), response.getRemark(), addr);</span>
    }

    public TopicList queryTopicsByConsumer(final String addr, final String group, final long timeoutMillis)
        throws RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException, InterruptedException,
        MQBrokerException {
<span class="nc" id="L2114">        QueryTopicsByConsumerRequestHeader requestHeader = new QueryTopicsByConsumerRequestHeader();</span>
<span class="nc" id="L2115">        requestHeader.setGroup(group);</span>

<span class="nc" id="L2117">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.QUERY_TOPICS_BY_CONSUMER, requestHeader);</span>
<span class="nc" id="L2118">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L2120" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L2122">                TopicList topicList = TopicList.decode(response.getBody(), TopicList.class);</span>
<span class="nc" id="L2123">                return topicList;</span>
            }
            default:
                break;
        }

<span class="nc" id="L2129">        throw new MQBrokerException(response.getCode(), response.getRemark());</span>
    }

    public SubscriptionData querySubscriptionByConsumer(final String addr, final String group, final String topic,
        final long timeoutMillis)
        throws RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException, InterruptedException,
        MQBrokerException {
<span class="nc" id="L2136">        QuerySubscriptionByConsumerRequestHeader requestHeader = new QuerySubscriptionByConsumerRequestHeader();</span>
<span class="nc" id="L2137">        requestHeader.setGroup(group);</span>
<span class="nc" id="L2138">        requestHeader.setTopic(topic);</span>

<span class="nc" id="L2140">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.QUERY_SUBSCRIPTION_BY_CONSUMER, requestHeader);</span>
<span class="nc" id="L2141">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L2143" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L2145">                QuerySubscriptionResponseBody subscriptionResponseBody =</span>
<span class="nc" id="L2146">                    QuerySubscriptionResponseBody.decode(response.getBody(), QuerySubscriptionResponseBody.class);</span>
<span class="nc" id="L2147">                return subscriptionResponseBody.getSubscriptionData();</span>
            }
            default:
                break;
        }

<span class="nc" id="L2153">        throw new MQBrokerException(response.getCode(), response.getRemark());</span>
    }

    public List&lt;QueueTimeSpan&gt; queryConsumeTimeSpan(final String addr, final String topic, final String group,
        final long timeoutMillis)
        throws RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException, InterruptedException,
        MQBrokerException {
<span class="nc" id="L2160">        QueryConsumeTimeSpanRequestHeader requestHeader = new QueryConsumeTimeSpanRequestHeader();</span>
<span class="nc" id="L2161">        requestHeader.setTopic(topic);</span>
<span class="nc" id="L2162">        requestHeader.setGroup(group);</span>

<span class="nc" id="L2164">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.QUERY_CONSUME_TIME_SPAN, requestHeader);</span>
<span class="nc" id="L2165">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L2167" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L2169">                QueryConsumeTimeSpanBody consumeTimeSpanBody = GroupList.decode(response.getBody(), QueryConsumeTimeSpanBody.class);</span>
<span class="nc" id="L2170">                return consumeTimeSpanBody.getConsumeTimeSpanSet();</span>
            }
            default:
                break;
        }

<span class="nc" id="L2176">        throw new MQBrokerException(response.getCode(), response.getRemark(), addr);</span>
    }

    public TopicList getTopicsByCluster(final String cluster, final long timeoutMillis)
        throws RemotingException, MQClientException, InterruptedException {
<span class="nc" id="L2181">        GetTopicsByClusterRequestHeader requestHeader = new GetTopicsByClusterRequestHeader();</span>
<span class="nc" id="L2182">        requestHeader.setCluster(cluster);</span>
<span class="nc" id="L2183">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_TOPICS_BY_CLUSTER, requestHeader);</span>
<span class="nc" id="L2184">        RemotingCommand response = this.remotingClient.invokeSync(null, request, timeoutMillis);</span>
<span class="nc bnc" id="L2185" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L2186" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L2188">                byte[] body = response.getBody();</span>
<span class="nc bnc" id="L2189" title="All 2 branches missed.">                if (body != null) {</span>
<span class="nc" id="L2190">                    TopicList topicList = TopicList.decode(body, TopicList.class);</span>
<span class="nc" id="L2191">                    return topicList;</span>
                }
            }
            default:
                break;
        }

<span class="nc" id="L2198">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public void registerMessageFilterClass(final String addr,
        final String consumerGroup,
        final String topic,
        final String className,
        final int classCRC,
        final byte[] classBody,
        final long timeoutMillis) throws RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException,
        InterruptedException, MQBrokerException {
<span class="nc" id="L2209">        RegisterMessageFilterClassRequestHeader requestHeader = new RegisterMessageFilterClassRequestHeader();</span>
<span class="nc" id="L2210">        requestHeader.setConsumerGroup(consumerGroup);</span>
<span class="nc" id="L2211">        requestHeader.setClassName(className);</span>
<span class="nc" id="L2212">        requestHeader.setTopic(topic);</span>
<span class="nc" id="L2213">        requestHeader.setClassCRC(classCRC);</span>

<span class="nc" id="L2215">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.REGISTER_MESSAGE_FILTER_CLASS, requestHeader);</span>
<span class="nc" id="L2216">        request.setBody(classBody);</span>
<span class="nc" id="L2217">        RemotingCommand response = this.remotingClient.invokeSync(addr, request, timeoutMillis);</span>
<span class="nc bnc" id="L2218" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L2220">                return;</span>
            }
            default:
                break;
        }

<span class="nc" id="L2226">        throw new MQBrokerException(response.getCode(), response.getRemark(), addr);</span>
    }

    public TopicList getSystemTopicList(
        final long timeoutMillis) throws RemotingException, MQClientException, InterruptedException {
<span class="nc" id="L2231">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_SYSTEM_TOPIC_LIST_FROM_NS, null);</span>
<span class="nc" id="L2232">        RemotingCommand response = this.remotingClient.invokeSync(null, request, timeoutMillis);</span>
<span class="nc bnc" id="L2233" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L2234" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L2236">                byte[] body = response.getBody();</span>
<span class="nc bnc" id="L2237" title="All 2 branches missed.">                if (body != null) {</span>
<span class="nc" id="L2238">                    TopicList topicList = TopicList.decode(response.getBody(), TopicList.class);</span>
<span class="nc bnc" id="L2239" title="All 4 branches missed.">                    if (topicList.getTopicList() != null &amp;&amp; !topicList.getTopicList().isEmpty()</span>
<span class="nc bnc" id="L2240" title="All 2 branches missed.">                        &amp;&amp; !UtilAll.isBlank(topicList.getBrokerAddr())) {</span>
<span class="nc" id="L2241">                        TopicList tmp = getSystemTopicListFromBroker(topicList.getBrokerAddr(), timeoutMillis);</span>
<span class="nc bnc" id="L2242" title="All 4 branches missed.">                        if (tmp.getTopicList() != null &amp;&amp; !tmp.getTopicList().isEmpty()) {</span>
<span class="nc" id="L2243">                            topicList.getTopicList().addAll(tmp.getTopicList());</span>
                        }
                    }
<span class="nc" id="L2246">                    return topicList;</span>
                }
            }
            default:
                break;
        }

<span class="nc" id="L2253">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public TopicList getSystemTopicListFromBroker(final String addr, final long timeoutMillis)
        throws RemotingException, MQClientException, InterruptedException {
<span class="nc" id="L2258">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_SYSTEM_TOPIC_LIST_FROM_BROKER, null);</span>
<span class="nc" id="L2259">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L2261" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L2262" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L2264">                byte[] body = response.getBody();</span>
<span class="nc bnc" id="L2265" title="All 2 branches missed.">                if (body != null) {</span>
<span class="nc" id="L2266">                    TopicList topicList = TopicList.decode(body, TopicList.class);</span>
<span class="nc" id="L2267">                    return topicList;</span>
                }
            }
            default:
                break;
        }

<span class="nc" id="L2274">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public boolean cleanExpiredConsumeQueue(final String addr,
        long timeoutMillis) throws MQClientException, RemotingConnectException,
        RemotingSendRequestException, RemotingTimeoutException, InterruptedException {
<span class="nc" id="L2280">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.CLEAN_EXPIRED_CONSUMEQUEUE, null);</span>
<span class="nc" id="L2281">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L2283" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L2285">                return true;</span>
            }
            default:
                break;
        }

<span class="nc" id="L2291">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public boolean deleteExpiredCommitLog(final String addr, long timeoutMillis) throws MQClientException,
        RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException, InterruptedException {
<span class="nc" id="L2296">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.DELETE_EXPIRED_COMMITLOG, null);</span>
<span class="nc" id="L2297">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L2299" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L2301">                return true;</span>
            }
            default:
                break;
        }

<span class="nc" id="L2307">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public boolean cleanUnusedTopicByAddr(final String addr,
        long timeoutMillis) throws MQClientException, RemotingConnectException,
        RemotingSendRequestException, RemotingTimeoutException, InterruptedException {
<span class="nc" id="L2313">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.CLEAN_UNUSED_TOPIC, null);</span>
<span class="nc" id="L2314">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L2316" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L2318">                return true;</span>
            }
            default:
                break;
        }

<span class="nc" id="L2324">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public ConsumerRunningInfo getConsumerRunningInfo(final String addr, String consumerGroup, String clientId,
        boolean jstack,
        final long timeoutMillis) throws RemotingException, MQClientException, InterruptedException {
<span class="nc" id="L2330">        GetConsumerRunningInfoRequestHeader requestHeader = new GetConsumerRunningInfoRequestHeader();</span>
<span class="nc" id="L2331">        requestHeader.setConsumerGroup(consumerGroup);</span>
<span class="nc" id="L2332">        requestHeader.setClientId(clientId);</span>
<span class="nc" id="L2333">        requestHeader.setJstackEnable(jstack);</span>

<span class="nc" id="L2335">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_CONSUMER_RUNNING_INFO, requestHeader);</span>

<span class="nc" id="L2337">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L2339" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L2340" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L2342">                byte[] body = response.getBody();</span>
<span class="nc bnc" id="L2343" title="All 2 branches missed.">                if (body != null) {</span>
<span class="nc" id="L2344">                    ConsumerRunningInfo info = ConsumerRunningInfo.decode(body, ConsumerRunningInfo.class);</span>
<span class="nc" id="L2345">                    return info;</span>
                }
            }
            default:
                break;
        }

<span class="nc" id="L2352">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public ConsumeMessageDirectlyResult consumeMessageDirectly(final String addr,
        String consumerGroup,
        String clientId,
        String topic,
        String msgId,
        final long timeoutMillis) throws RemotingException, MQClientException, InterruptedException {
<span class="nc" id="L2361">        ConsumeMessageDirectlyResultRequestHeader requestHeader = new ConsumeMessageDirectlyResultRequestHeader();</span>
<span class="nc" id="L2362">        requestHeader.setTopic(topic);</span>
<span class="nc" id="L2363">        requestHeader.setConsumerGroup(consumerGroup);</span>
<span class="nc" id="L2364">        requestHeader.setClientId(clientId);</span>
<span class="nc" id="L2365">        requestHeader.setMsgId(msgId);</span>

<span class="nc" id="L2367">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.CONSUME_MESSAGE_DIRECTLY, requestHeader);</span>

<span class="nc" id="L2369">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L2371" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L2372" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L2374">                byte[] body = response.getBody();</span>
<span class="nc bnc" id="L2375" title="All 2 branches missed.">                if (body != null) {</span>
<span class="nc" id="L2376">                    ConsumeMessageDirectlyResult info = ConsumeMessageDirectlyResult.decode(body, ConsumeMessageDirectlyResult.class);</span>
<span class="nc" id="L2377">                    return info;</span>
                }
            }
            default:
                break;
        }

<span class="nc" id="L2384">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public Map&lt;Integer, Long&gt; queryCorrectionOffset(final String addr, final String topic, final String group,
        Set&lt;String&gt; filterGroup,
        long timeoutMillis) throws MQClientException, RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException,
        InterruptedException {
<span class="nc" id="L2391">        QueryCorrectionOffsetHeader requestHeader = new QueryCorrectionOffsetHeader();</span>
<span class="nc" id="L2392">        requestHeader.setCompareGroup(group);</span>
<span class="nc" id="L2393">        requestHeader.setTopic(topic);</span>
<span class="nc bnc" id="L2394" title="All 2 branches missed.">        if (filterGroup != null) {</span>
<span class="nc" id="L2395">            StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L2396">            String splitor = &quot;&quot;;</span>
<span class="nc bnc" id="L2397" title="All 2 branches missed.">            for (String s : filterGroup) {</span>
<span class="nc" id="L2398">                sb.append(splitor).append(s);</span>
<span class="nc" id="L2399">                splitor = &quot;,&quot;;</span>
<span class="nc" id="L2400">            }</span>
<span class="nc" id="L2401">            requestHeader.setFilterGroups(sb.toString());</span>
        }
<span class="nc" id="L2403">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.QUERY_CORRECTION_OFFSET, requestHeader);</span>
<span class="nc" id="L2404">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L2406" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L2407" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc bnc" id="L2409" title="All 2 branches missed.">                if (response.getBody() != null) {</span>
<span class="nc" id="L2410">                    QueryCorrectionOffsetBody body = QueryCorrectionOffsetBody.decode(response.getBody(), QueryCorrectionOffsetBody.class);</span>
<span class="nc" id="L2411">                    return body.getCorrectionOffsets();</span>
                }
            }
            default:
                break;
        }

<span class="nc" id="L2418">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public TopicList getUnitTopicList(final boolean containRetry, final long timeoutMillis)
        throws RemotingException, MQClientException, InterruptedException {
<span class="nc" id="L2423">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_UNIT_TOPIC_LIST, null);</span>
<span class="nc" id="L2424">        RemotingCommand response = this.remotingClient.invokeSync(null, request, timeoutMillis);</span>
<span class="nc bnc" id="L2425" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L2426" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L2428">                byte[] body = response.getBody();</span>
<span class="nc bnc" id="L2429" title="All 2 branches missed.">                if (body != null) {</span>
<span class="nc" id="L2430">                    TopicList topicList = TopicList.decode(response.getBody(), TopicList.class);</span>
<span class="nc bnc" id="L2431" title="All 2 branches missed.">                    if (!containRetry) {</span>
<span class="nc" id="L2432">                        Iterator&lt;String&gt; it = topicList.getTopicList().iterator();</span>
<span class="nc bnc" id="L2433" title="All 2 branches missed.">                        while (it.hasNext()) {</span>
<span class="nc" id="L2434">                            String topic = it.next();</span>
<span class="nc bnc" id="L2435" title="All 2 branches missed.">                            if (topic.startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {</span>
<span class="nc" id="L2436">                                it.remove();</span>
                            }
<span class="nc" id="L2438">                        }</span>
                    }

<span class="nc" id="L2441">                    return topicList;</span>
                }
            }
            default:
                break;
        }

<span class="nc" id="L2448">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public TopicList getHasUnitSubTopicList(final boolean containRetry, final long timeoutMillis)
        throws RemotingException, MQClientException, InterruptedException {
<span class="nc" id="L2453">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_HAS_UNIT_SUB_TOPIC_LIST, null);</span>
<span class="nc" id="L2454">        RemotingCommand response = this.remotingClient.invokeSync(null, request, timeoutMillis);</span>
<span class="nc bnc" id="L2455" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L2456" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L2458">                byte[] body = response.getBody();</span>
<span class="nc bnc" id="L2459" title="All 2 branches missed.">                if (body != null) {</span>
<span class="nc" id="L2460">                    TopicList topicList = TopicList.decode(response.getBody(), TopicList.class);</span>
<span class="nc bnc" id="L2461" title="All 2 branches missed.">                    if (!containRetry) {</span>
<span class="nc" id="L2462">                        Iterator&lt;String&gt; it = topicList.getTopicList().iterator();</span>
<span class="nc bnc" id="L2463" title="All 2 branches missed.">                        while (it.hasNext()) {</span>
<span class="nc" id="L2464">                            String topic = it.next();</span>
<span class="nc bnc" id="L2465" title="All 2 branches missed.">                            if (topic.startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {</span>
<span class="nc" id="L2466">                                it.remove();</span>
                            }
<span class="nc" id="L2468">                        }</span>
                    }
<span class="nc" id="L2470">                    return topicList;</span>
                }
            }
            default:
                break;
        }

<span class="nc" id="L2477">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public TopicList getHasUnitSubUnUnitTopicList(final boolean containRetry, final long timeoutMillis)
        throws RemotingException, MQClientException, InterruptedException {
<span class="nc" id="L2482">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_HAS_UNIT_SUB_UNUNIT_TOPIC_LIST, null);</span>
<span class="nc" id="L2483">        RemotingCommand response = this.remotingClient.invokeSync(null, request, timeoutMillis);</span>
<span class="nc bnc" id="L2484" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L2485" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L2487">                byte[] body = response.getBody();</span>
<span class="nc bnc" id="L2488" title="All 2 branches missed.">                if (body != null) {</span>
<span class="nc" id="L2489">                    TopicList topicList = TopicList.decode(response.getBody(), TopicList.class);</span>
<span class="nc bnc" id="L2490" title="All 2 branches missed.">                    if (!containRetry) {</span>
<span class="nc" id="L2491">                        Iterator&lt;String&gt; it = topicList.getTopicList().iterator();</span>
<span class="nc bnc" id="L2492" title="All 2 branches missed.">                        while (it.hasNext()) {</span>
<span class="nc" id="L2493">                            String topic = it.next();</span>
<span class="nc bnc" id="L2494" title="All 2 branches missed.">                            if (topic.startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) {</span>
<span class="nc" id="L2495">                                it.remove();</span>
                            }
<span class="nc" id="L2497">                        }</span>
                    }
<span class="nc" id="L2499">                    return topicList;</span>
                }
            }
            default:
                break;
        }

<span class="nc" id="L2506">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public void cloneGroupOffset(final String addr, final String srcGroup, final String destGroup, final String topic,
        final boolean isOffline,
        final long timeoutMillis) throws RemotingException, MQClientException, InterruptedException {
<span class="nc" id="L2512">        CloneGroupOffsetRequestHeader requestHeader = new CloneGroupOffsetRequestHeader();</span>
<span class="nc" id="L2513">        requestHeader.setSrcGroup(srcGroup);</span>
<span class="nc" id="L2514">        requestHeader.setDestGroup(destGroup);</span>
<span class="nc" id="L2515">        requestHeader.setTopic(topic);</span>
<span class="nc" id="L2516">        requestHeader.setOffline(isOffline);</span>
<span class="nc" id="L2517">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.CLONE_GROUP_OFFSET, requestHeader);</span>
<span class="nc" id="L2518">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L2520" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L2521" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L2523">                return;</span>
            }
            default:
                break;
        }

<span class="nc" id="L2529">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public BrokerStatsData viewBrokerStatsData(String brokerAddr, String statsName, String statsKey, long timeoutMillis)
        throws MQClientException, RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException,
        InterruptedException {
<span class="nc" id="L2535">        ViewBrokerStatsDataRequestHeader requestHeader = new ViewBrokerStatsDataRequestHeader();</span>
<span class="nc" id="L2536">        requestHeader.setStatsName(statsName);</span>
<span class="nc" id="L2537">        requestHeader.setStatsKey(statsKey);</span>

<span class="nc" id="L2539">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.VIEW_BROKER_STATS_DATA, requestHeader);</span>
<span class="nc" id="L2540">        RemotingCommand response = this.remotingClient</span>
<span class="nc" id="L2541">            .invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), brokerAddr), request, timeoutMillis);</span>
<span class="nc bnc" id="L2542" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L2543" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L2545">                byte[] body = response.getBody();</span>
<span class="nc bnc" id="L2546" title="All 2 branches missed.">                if (body != null) {</span>
<span class="nc" id="L2547">                    return BrokerStatsData.decode(body, BrokerStatsData.class);</span>
                }
            }
            default:
                break;
        }

<span class="nc" id="L2554">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public Set&lt;String&gt; getClusterList(String topic,
        long timeoutMillis) {
<span class="nc" id="L2559">        return Collections.EMPTY_SET;</span>
    }

    public ConsumeStatsList fetchConsumeStatsInBroker(String brokerAddr, boolean isOrder,
        long timeoutMillis) throws MQClientException,
        RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException, InterruptedException {
<span class="nc" id="L2565">        GetConsumeStatsInBrokerHeader requestHeader = new GetConsumeStatsInBrokerHeader();</span>
<span class="nc" id="L2566">        requestHeader.setIsOrder(isOrder);</span>

<span class="nc" id="L2568">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_BROKER_CONSUME_STATS, requestHeader);</span>
<span class="nc" id="L2569">        RemotingCommand response = this.remotingClient</span>
<span class="nc" id="L2570">            .invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), brokerAddr), request, timeoutMillis);</span>
<span class="nc bnc" id="L2571" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L2572" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L2574">                byte[] body = response.getBody();</span>
<span class="nc bnc" id="L2575" title="All 2 branches missed.">                if (body != null) {</span>
<span class="nc" id="L2576">                    return ConsumeStatsList.decode(body, ConsumeStatsList.class);</span>
                }
            }
            default:
                break;
        }

<span class="nc" id="L2583">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public SubscriptionGroupWrapper getAllSubscriptionGroup(final String brokerAddr,
        long timeoutMillis) throws InterruptedException,
        RemotingTimeoutException, RemotingSendRequestException, RemotingConnectException, MQBrokerException {
<span class="nc" id="L2589">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_ALL_SUBSCRIPTIONGROUP_CONFIG, null);</span>
<span class="nc" id="L2590">        RemotingCommand response = this.remotingClient</span>
<span class="nc" id="L2591">            .invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), brokerAddr), request, timeoutMillis);</span>
<span class="nc bnc" id="L2592" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L2593" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L2595">                return SubscriptionGroupWrapper.decode(response.getBody(), SubscriptionGroupWrapper.class);</span>
            }
            default:
                break;
        }
<span class="nc" id="L2600">        throw new MQBrokerException(response.getCode(), response.getRemark(), brokerAddr);</span>
    }

    public SubscriptionGroupConfig getSubscriptionGroupConfig(final String brokerAddr, String group,
        long timeoutMillis) throws InterruptedException,
        RemotingTimeoutException, RemotingSendRequestException, RemotingConnectException, MQBrokerException {
<span class="nc" id="L2606">        GetSubscriptionGroupConfigRequestHeader header = new GetSubscriptionGroupConfigRequestHeader();</span>
<span class="nc" id="L2607">        header.setGroup(group);</span>
<span class="nc" id="L2608">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_SUBSCRIPTIONGROUP_CONFIG, header);</span>
<span class="nc" id="L2609">        RemotingCommand response = this.remotingClient</span>
<span class="nc" id="L2610">            .invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), brokerAddr), request, timeoutMillis);</span>
<span class="nc bnc" id="L2611" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L2612" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L2614">                return RemotingSerializable.decode(response.getBody(), SubscriptionGroupConfig.class);</span>
            }
            default:
                break;
        }
<span class="nc" id="L2619">        throw new MQBrokerException(response.getCode(), response.getRemark(), brokerAddr);</span>
    }

    public TopicConfigSerializeWrapper getAllTopicConfig(final String addr,
        long timeoutMillis) throws RemotingConnectException,
        RemotingSendRequestException, RemotingTimeoutException, InterruptedException, MQBrokerException {
<span class="nc" id="L2625">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_ALL_TOPIC_CONFIG, null);</span>

<span class="nc" id="L2627">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L2629" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L2630" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L2632">                return TopicConfigSerializeWrapper.decode(response.getBody(), TopicConfigSerializeWrapper.class);</span>
            }
            default:
                break;
        }

<span class="nc" id="L2638">        throw new MQBrokerException(response.getCode(), response.getRemark(), addr);</span>
    }

    public void updateNameServerConfig(final Properties properties, final List&lt;String&gt; nameServers, long timeoutMillis)
        throws UnsupportedEncodingException, InterruptedException, RemotingTimeoutException, RemotingSendRequestException,
        RemotingConnectException, MQClientException {
<span class="nc" id="L2644">        String str = MixAll.properties2String(properties);</span>
<span class="nc bnc" id="L2645" title="All 4 branches missed.">        if (str == null || str.length() &lt; 1) {</span>
<span class="nc" id="L2646">            return;</span>
        }
<span class="nc bnc" id="L2648" title="All 4 branches missed.">        List&lt;String&gt; invokeNameServers = (nameServers == null || nameServers.isEmpty()) ?</span>
<span class="nc" id="L2649">            this.remotingClient.getNameServerAddressList() : nameServers;</span>
<span class="nc bnc" id="L2650" title="All 4 branches missed.">        if (invokeNameServers == null || invokeNameServers.isEmpty()) {</span>
<span class="nc" id="L2651">            return;</span>
        }

<span class="nc" id="L2654">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.UPDATE_NAMESRV_CONFIG, null);</span>
<span class="nc" id="L2655">        request.setBody(str.getBytes(MixAll.DEFAULT_CHARSET));</span>

<span class="nc" id="L2657">        RemotingCommand errResponse = null;</span>
<span class="nc bnc" id="L2658" title="All 2 branches missed.">        for (String nameServer : invokeNameServers) {</span>
<span class="nc" id="L2659">            RemotingCommand response = this.remotingClient.invokeSync(nameServer, request, timeoutMillis);</span>
<span class="nc bnc" id="L2660" title="All 4 branches missed.">            assert response != null;</span>
<span class="nc bnc" id="L2661" title="All 2 branches missed.">            switch (response.getCode()) {</span>
                case ResponseCode.SUCCESS: {
<span class="nc" id="L2663">                    break;</span>
                }
                default:
<span class="nc" id="L2666">                    errResponse = response;</span>
            }
<span class="nc" id="L2668">        }</span>

<span class="nc bnc" id="L2670" title="All 2 branches missed.">        if (errResponse != null) {</span>
<span class="nc" id="L2671">            throw new MQClientException(errResponse.getCode(), errResponse.getRemark());</span>
        }
<span class="nc" id="L2673">    }</span>

    public Map&lt;String, Properties&gt; getNameServerConfig(final List&lt;String&gt; nameServers, long timeoutMillis)
        throws InterruptedException,
        RemotingTimeoutException, RemotingSendRequestException, RemotingConnectException,
        MQClientException, UnsupportedEncodingException {
<span class="nc bnc" id="L2679" title="All 4 branches missed.">        List&lt;String&gt; invokeNameServers = (nameServers == null || nameServers.isEmpty()) ?</span>
<span class="nc" id="L2680">            this.remotingClient.getNameServerAddressList() : nameServers;</span>
<span class="nc bnc" id="L2681" title="All 4 branches missed.">        if (invokeNameServers == null || invokeNameServers.isEmpty()) {</span>
<span class="nc" id="L2682">            return null;</span>
        }

<span class="nc" id="L2685">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_NAMESRV_CONFIG, null);</span>

<span class="nc" id="L2687">        Map&lt;String, Properties&gt; configMap = new HashMap&lt;String, Properties&gt;(4);</span>
<span class="nc bnc" id="L2688" title="All 2 branches missed.">        for (String nameServer : invokeNameServers) {</span>
<span class="nc" id="L2689">            RemotingCommand response = this.remotingClient.invokeSync(nameServer, request, timeoutMillis);</span>

<span class="nc bnc" id="L2691" title="All 4 branches missed.">            assert response != null;</span>

<span class="nc bnc" id="L2693" title="All 2 branches missed.">            if (ResponseCode.SUCCESS == response.getCode()) {</span>
<span class="nc" id="L2694">                configMap.put(nameServer, MixAll.string2Properties(new String(response.getBody(), MixAll.DEFAULT_CHARSET)));</span>
            } else {
<span class="nc" id="L2696">                throw new MQClientException(response.getCode(), response.getRemark());</span>
            }
<span class="nc" id="L2698">        }</span>
<span class="nc" id="L2699">        return configMap;</span>
    }

    public QueryConsumeQueueResponseBody queryConsumeQueue(final String brokerAddr, final String topic,
        final int queueId,
        final long index, final int count, final String consumerGroup,
        final long timeoutMillis) throws InterruptedException,
        RemotingTimeoutException, RemotingSendRequestException, RemotingConnectException, MQClientException {

<span class="nc" id="L2708">        QueryConsumeQueueRequestHeader requestHeader = new QueryConsumeQueueRequestHeader();</span>
<span class="nc" id="L2709">        requestHeader.setTopic(topic);</span>
<span class="nc" id="L2710">        requestHeader.setQueueId(queueId);</span>
<span class="nc" id="L2711">        requestHeader.setIndex(index);</span>
<span class="nc" id="L2712">        requestHeader.setCount(count);</span>
<span class="nc" id="L2713">        requestHeader.setConsumerGroup(consumerGroup);</span>

<span class="nc" id="L2715">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.QUERY_CONSUME_QUEUE, requestHeader);</span>
<span class="nc" id="L2716">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), brokerAddr), request, timeoutMillis);</span>

<span class="nc bnc" id="L2718" title="All 4 branches missed.">        assert response != null;</span>

<span class="nc bnc" id="L2720" title="All 2 branches missed.">        if (ResponseCode.SUCCESS == response.getCode()) {</span>
<span class="nc" id="L2721">            return QueryConsumeQueueResponseBody.decode(response.getBody(), QueryConsumeQueueResponseBody.class);</span>
        }

<span class="nc" id="L2724">        throw new MQClientException(response.getCode(), response.getRemark());</span>
    }

    public void checkClientInBroker(final String brokerAddr, final String consumerGroup,
        final String clientId, final SubscriptionData subscriptionData,
        final long timeoutMillis)
        throws InterruptedException, RemotingTimeoutException, RemotingSendRequestException,
        RemotingConnectException, MQClientException {
<span class="nc" id="L2732">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.CHECK_CLIENT_CONFIG, null);</span>

<span class="nc" id="L2734">        CheckClientRequestBody requestBody = new CheckClientRequestBody();</span>
<span class="nc" id="L2735">        requestBody.setClientId(clientId);</span>
<span class="nc" id="L2736">        requestBody.setGroup(consumerGroup);</span>
<span class="nc" id="L2737">        requestBody.setSubscriptionData(subscriptionData);</span>

<span class="nc" id="L2739">        request.setBody(requestBody.encode());</span>

<span class="nc" id="L2741">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), brokerAddr), request, timeoutMillis);</span>

<span class="nc bnc" id="L2743" title="All 4 branches missed.">        assert response != null;</span>

<span class="nc bnc" id="L2745" title="All 2 branches missed.">        if (ResponseCode.SUCCESS != response.getCode()) {</span>
<span class="nc" id="L2746">            throw new MQClientException(response.getCode(), response.getRemark());</span>
        }
<span class="nc" id="L2748">    }</span>

    public boolean resumeCheckHalfMessage(final String addr, String msgId,
        final long timeoutMillis) throws RemotingException, InterruptedException {
<span class="fc" id="L2752">        ResumeCheckHalfMessageRequestHeader requestHeader = new ResumeCheckHalfMessageRequestHeader();</span>
<span class="fc" id="L2753">        requestHeader.setMsgId(msgId);</span>

<span class="fc" id="L2755">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.RESUME_CHECK_HALF_MESSAGE, requestHeader);</span>

<span class="fc" id="L2757">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="pc bpc" id="L2759" title="2 of 4 branches missed.">        assert response != null;</span>
<span class="fc bfc" id="L2760" title="All 2 branches covered.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="fc" id="L2762">                return true;</span>
            }
            default:
<span class="fc" id="L2765">                log.error(&quot;Failed to resume half message check logic. Remark={}&quot;, response.getRemark());</span>
<span class="fc" id="L2766">                return false;</span>
        }
    }

    public void setMessageRequestMode(final String brokerAddr, final String topic, final String consumerGroup,
        final MessageRequestMode mode, final int popShareQueueNum, final long timeoutMillis)
        throws InterruptedException, RemotingTimeoutException, RemotingSendRequestException,
        RemotingConnectException, MQClientException {
<span class="fc" id="L2774">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.SET_MESSAGE_REQUEST_MODE, null);</span>

<span class="fc" id="L2776">        SetMessageRequestModeRequestBody requestBody = new SetMessageRequestModeRequestBody();</span>
<span class="fc" id="L2777">        requestBody.setTopic(topic);</span>
<span class="fc" id="L2778">        requestBody.setConsumerGroup(consumerGroup);</span>
<span class="fc" id="L2779">        requestBody.setMode(mode);</span>
<span class="fc" id="L2780">        requestBody.setPopShareQueueNum(popShareQueueNum);</span>
<span class="fc" id="L2781">        request.setBody(requestBody.encode());</span>

<span class="fc" id="L2783">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), brokerAddr), request, timeoutMillis);</span>
<span class="pc bpc" id="L2784" title="2 of 4 branches missed.">        assert response != null;</span>
<span class="pc bpc" id="L2785" title="1 of 2 branches missed.">        if (ResponseCode.SUCCESS != response.getCode()) {</span>
<span class="nc" id="L2786">            throw new MQClientException(response.getCode(), response.getRemark());</span>
        }
<span class="fc" id="L2788">    }</span>

    public TopicConfigAndQueueMapping getTopicConfig(final String brokerAddr, String topic,
        long timeoutMillis) throws InterruptedException,
        RemotingTimeoutException, RemotingSendRequestException, RemotingConnectException, MQBrokerException {
<span class="nc" id="L2793">        GetTopicConfigRequestHeader header = new GetTopicConfigRequestHeader();</span>
<span class="nc" id="L2794">        header.setTopic(topic);</span>
<span class="nc" id="L2795">        header.setLo(true);</span>
<span class="nc" id="L2796">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_TOPIC_CONFIG, header);</span>
<span class="nc" id="L2797">        RemotingCommand response = this.remotingClient</span>
<span class="nc" id="L2798">            .invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), brokerAddr), request, timeoutMillis);</span>
<span class="nc bnc" id="L2799" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L2800" title="All 3 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L2802">                return RemotingSerializable.decode(response.getBody(), TopicConfigAndQueueMapping.class);</span>
            }
            //should check the exist
            case ResponseCode.TOPIC_NOT_EXIST: {
                //should return null?
<span class="nc" id="L2807">                break;</span>
            }
            default:
                break;
        }
<span class="nc" id="L2812">        throw new MQBrokerException(response.getCode(), response.getRemark());</span>
    }

    public void createStaticTopic(final String addr, final String defaultTopic, final TopicConfig topicConfig,
        final TopicQueueMappingDetail topicQueueMappingDetail, boolean force,
        final long timeoutMillis) throws RemotingException, InterruptedException, MQBrokerException {
<span class="nc" id="L2818">        CreateTopicRequestHeader requestHeader = new CreateTopicRequestHeader();</span>
<span class="nc" id="L2819">        requestHeader.setTopic(topicConfig.getTopicName());</span>
<span class="nc" id="L2820">        requestHeader.setDefaultTopic(defaultTopic);</span>
<span class="nc" id="L2821">        requestHeader.setReadQueueNums(topicConfig.getReadQueueNums());</span>
<span class="nc" id="L2822">        requestHeader.setWriteQueueNums(topicConfig.getWriteQueueNums());</span>
<span class="nc" id="L2823">        requestHeader.setPerm(topicConfig.getPerm());</span>
<span class="nc" id="L2824">        requestHeader.setTopicFilterType(topicConfig.getTopicFilterType().name());</span>
<span class="nc" id="L2825">        requestHeader.setTopicSysFlag(topicConfig.getTopicSysFlag());</span>
<span class="nc" id="L2826">        requestHeader.setOrder(topicConfig.isOrder());</span>
<span class="nc" id="L2827">        requestHeader.setForce(force);</span>
<span class="nc" id="L2828">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.UPDATE_AND_CREATE_STATIC_TOPIC, requestHeader);</span>
<span class="nc" id="L2829">        request.setBody(topicQueueMappingDetail.encode());</span>

<span class="nc" id="L2831">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L2833" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L2834" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L2836">                return;</span>
            }
            default:
                break;
        }

<span class="nc" id="L2842">        throw new MQBrokerException(response.getCode(), response.getRemark());</span>
    }

    /**
     * @param addr
     * @param requestHeader
     * @param timeoutMillis
     * @throws InterruptedException
     * @throws RemotingTimeoutException
     * @throws RemotingSendRequestException
     * @throws RemotingConnectException
     * @throws MQBrokerException
     */
    public GroupForbidden updateAndGetGroupForbidden(String addr, UpdateGroupForbiddenRequestHeader requestHeader,
        long timeoutMillis) throws RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException, InterruptedException, MQBrokerException {
<span class="nc" id="L2857">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.UPDATE_AND_GET_GROUP_FORBIDDEN, requestHeader);</span>

<span class="nc" id="L2859">        RemotingCommand response = this.remotingClient.invokeSync(MixAll.brokerVIPChannel(this.clientConfig.isVipChannelEnabled(), addr),</span>
            request, timeoutMillis);
<span class="nc bnc" id="L2861" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L2862" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L2864">                return RemotingSerializable.decode(response.getBody(), GroupForbidden.class);</span>
            }
            default:
                break;
        }

<span class="nc" id="L2870">        throw new MQBrokerException(response.getCode(), response.getRemark(), addr);</span>
    }

    public void resetMasterFlushOffset(final String brokerAddr, final long masterFlushOffset)
        throws InterruptedException, RemotingTimeoutException, RemotingSendRequestException, RemotingConnectException, MQBrokerException {
<span class="nc" id="L2875">        ResetMasterFlushOffsetHeader requestHeader = new ResetMasterFlushOffsetHeader();</span>
<span class="nc" id="L2876">        requestHeader.setMasterFlushOffset(masterFlushOffset);</span>

<span class="nc" id="L2878">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.RESET_MASTER_FLUSH_OFFSET, requestHeader);</span>

<span class="nc" id="L2880">        RemotingCommand response = this.remotingClient.invokeSync(brokerAddr, request, 3000);</span>
<span class="nc bnc" id="L2881" title="All 4 branches missed.">        assert response != null;</span>
<span class="nc bnc" id="L2882" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L2884">                return;</span>
            }
            default:
                break;
        }
<span class="nc" id="L2889">        throw new MQBrokerException(response.getCode(), response.getRemark(), brokerAddr);</span>
    }

    public HARuntimeInfo getBrokerHAStatus(final String brokerAddr, final long timeoutMillis)
        throws RemotingConnectException, RemotingSendRequestException, RemotingTimeoutException,
        InterruptedException, MQBrokerException {
<span class="nc" id="L2895">        RemotingCommand request = RemotingCommand.createRequestCommand(RequestCode.GET_BROKER_HA_STATUS, null);</span>
<span class="nc" id="L2896">        RemotingCommand response = this.remotingClient.invokeSync(brokerAddr, request, timeoutMillis);</span>
<span class="nc bnc" id="L2897" title="All 4 branches missed.">        assert response != null;</span>

<span class="nc bnc" id="L2899" title="All 2 branches missed.">        switch (response.getCode()) {</span>
            case ResponseCode.SUCCESS: {
<span class="nc" id="L2901">                return HARuntimeInfo.decode(response.getBody(), HARuntimeInfo.class);</span>
            }
            default:
                break;
        }

<span class="nc" id="L2907">        throw new MQBrokerException(response.getCode(), response.getRemark());</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>